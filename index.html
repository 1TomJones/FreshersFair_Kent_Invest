<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Welcome Fair — Trading Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
      @media (max-width: 480px) {
        .chart-card { padding: 0 !important; border-radius: 16px !important; }
      }
      .noselect { -webkit-user-select:none; -moz-user-select:none; user-select:none; }
      .btn { transition: transform .05s ease; }
      .btn:active { transform: scale(0.98); }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>
    <script>
      const { useState, useEffect, useRef, useMemo } = React;

      // ---------- Config & Utils ----------
      const TICKER = "SPX";
      const fmt2 = n => Number(n).toFixed(2);
      const clamp = (x,a,b) => Math.max(a, Math.min(b, x));
      const LB_KEY = "liquidity_fair_leaderboard_v11";
      const MAX_POS = 1000;

      const loadLB = () => { try { return JSON.parse(localStorage.getItem(LB_KEY)) || []; } catch { return []; } };
      const saveLB = (arr) => localStorage.setItem(LB_KEY, JSON.stringify(arr));

      // ====== Audio ======
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      let audioCtx; try { audioCtx = new AudioCtx(); } catch(e) {}
      function _envGain(g, t0, dur, vol=0.03){ try{ g.gain.setValueAtTime(Math.max(0.0001,vol),t0); g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);}catch{} }
      function beep(freq=440, dur=0.15, type="sine", vol=0.03){
        if (!audioCtx) return; const t = audioCtx.currentTime;
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = type; o.frequency.value = freq; _envGain(g,t,dur,vol);
        o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+dur);
      }
      function chirp(start=400, end=800, dur=0.2, type="sine", vol=0.03){
        if (!audioCtx) return; const t = audioCtx.currentTime;
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(start,t); o.frequency.linearRampToValueAtTime(end,t+dur);
        _envGain(g,t,dur,vol); o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+dur);
      }
      function chord(freqs=[440,550,660], dur=0.5, vol=0.02){
        if (!audioCtx) return; const t = audioCtx.currentTime;
        const bus = audioCtx.createGain(); bus.gain.setValueAtTime(vol,t); bus.connect(audioCtx.destination);
        freqs.forEach(f=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain();
          o.type="sine"; o.frequency.value=f; _envGain(g,t,dur,1); o.connect(g).connect(bus); o.start(t); o.stop(t+dur);
        });
      }

      // ---------- Brand (logo) ----------
      function Brand({ size = 40, withText = false, text = "Welcome Fair — Trading Game" }) {
        return React.createElement("div", { className: "flex items-center gap-3" }, [
          React.createElement("img", {
            key: "logo",
            src: "assets/Kent_Invest_Logo.png",
            alt: "Kent Invest",
            className: "rounded-[8px]",
            style: { height: size + "px", width: "auto" }
          }),
          withText && React.createElement("span", { key: "txt", className: "font-bold text-2xl" }, text)
        ]);
      }

      // ---------- Responsive helper ----------
      function useIsMobile(breakpointPx = 480){
        const [isMobile, setIsMobile] = useState(() => window.innerWidth <= breakpointPx);
        useEffect(() => {
          const onResize = () => setIsMobile(window.innerWidth <= breakpointPx);
          window.addEventListener("resize", onResize);
          return () => window.removeEventListener("resize", onResize);
        }, [breakpointPx]);
        return isMobile;
      }


// ---------- Chart (edge-to-edge, VWAP, trade markers, news bubbles) ----------
// --- helper: measure container width with ResizeObserver ---
function useMeasureWidth(){
  const ref = React.useRef(null);
  const [w, setW] = React.useState(0);
  React.useEffect(() => {
    const el = ref.current;
    if (!el) return;
    const ro = new ResizeObserver(entries => {
      const cr = entries[0]?.contentRect;
      if (cr && cr.width) setW(cr.width);
    });
    ro.observe(el);
    return () => ro.disconnect();
  }, []);
  return [ref, w];
}

// ---------- Chart (responsive height, margins, proper clipping) ----------
function PriceChart({
  data,
  fairLine = null,
  // these two are ignored now; height is computed from width
  heightVhDesktop = 38,
  heightVhMobile = 62,
  mobileWindowPct = 0.60, // show last 60% on mobile
  newsEvents = [],
  trades = [],
  posAvg = null,
  posSide = 0
}){
  // placeholder if no data
  if (!data || data.length === 0) {
    return React.createElement("div",{className:"rounded-2xl border border-slate-200 shadow-sm bg-white chart-card", style:{height:280}});
  }

  const isMobile = (typeof window!=="undefined") && window.innerWidth <= 480;

  // Measure container width and compute pixel height from aspect (no vh!)
  const [wrapRef, cw] = useMeasureWidth();
  const widthPx = Math.max(240, cw || 600);

  // Choose aspect & clamps
  const aspect   = isMobile ? 0.52 : 0.35;                 // H ≈ aspect * W
  const minH     = isMobile ? 240   : 220;
  const maxH     = isMobile ? 520   : 420;
  const heightPx = Math.round(Math.max(minH, Math.min(maxH, widthPx * aspect)));

  // SVG coordinate system matches pixel size (makes life easy)
  const W = widthPx;
  const H = heightPx;

  // Margins (reserve space for labels so they don't get clipped)
  const M = isMobile
    ? { top: 10, right: 8, bottom: 16, left: 52 }
    : { top: 12, right: 10, bottom: 20, left: 60 };
  const plotW = Math.max(10, W - M.left - M.right);
  const plotH = Math.max(10, H - M.top - M.bottom);

  // --- choose window of data (mobile = last % of ticks) ---
  const nAll = data.length;
  const nMobile = Math.max(80, Math.round(nAll * mobileWindowPct));
  const startIdx = isMobile ? Math.max(0, nAll - nMobile) : 0;
  const series = data.slice(startIdx);
  const n = series.length;

  // Y domain from visible window with smart padding
  const ys = series.map(d => d.mid);
  let minY = Math.min(...ys), maxY = Math.max(...ys);
  let rangeY = maxY - minY;
  const padAbs = Math.max(rangeY * 0.02, 0.15); // keep tiny absolute pad even if calm
  if (!isFinite(rangeY) || rangeY <= 0) { rangeY = 0.5; minY -= 0.25; maxY += 0.25; }
  minY -= padAbs; maxY += padAbs; rangeY = Math.max(0.1, maxY - minY);

  // Map abs tick to local index
  const firstTick = series[0].t;
  const toLocalIndex = absTick => absTick - firstTick;

  // Scales
  const xOfIndex = (i) => M.left + (i/Math.max(1,n-1)) * plotW;
  const yOf = (v) => M.top + (1 - (v - minY) / rangeY) * plotH;

  // Build polylines
  const pts = series.map((d,i)=>`${xOfIndex(i)},${yOf(d.mid)}`).join(" ");
  const recentCount = Math.min(200, n);
  const startRecent = Math.max(0, n - recentCount);
  const recentPts = series.slice(startRecent).map((d,i)=>`${xOfIndex(startRecent+i)},${yOf(d.mid)}`).join(" ");

  // Y ticks/grid (NOT clipped)
  const tickCount = isMobile ? 3 : 5;
  const yTicks = [];
  for (let k=0; k<tickCount; k++){
    const t = (tickCount===1) ? 0 : (k/(tickCount-1));
    const v = maxY - t*rangeY;
    const y = yOf(v);
    yTicks.push(
      React.createElement("line",{key:`gl${k}`,x1:M.left,y1:y,x2:M.left+plotW,y2:y,stroke:"#eef2f7","stroke-width":1}),
      React.createElement("text",{key:`gt${k}`,x:M.left-6,y:y+4,"text-anchor":"end",className:`fill-gray-800 ${isMobile?"text-[12px]":"text-[14px]"} font-semibold noselect`}, fmt2(v))
    );
  }

  // Fair value (if present) — draw inside plotting area but NOT clipped (so label shows)
  const fvElems = [];
  if (fairLine != null){
    const yF = yOf(fairLine);
    fvElems.push(
      React.createElement("line",{key:"fv",x1:M.left,y1:yF,x2:M.left+plotW,y2:yF,stroke:"#94a3b8","stroke-width":1.4,"stroke-dasharray":"4 4",opacity:0.85})
    );
  }

  // VWAP (clipped with series)
  const vwapLine = [];
  if (posAvg != null && posSide !== 0){
    vwapLine.push(
      React.createElement("line",{key:"vwap",x1:M.left,y1:yOf(posAvg),x2:M.left+plotW,y2:yOf(posAvg),
        stroke: posSide>0 ? "#10b981" : "#ef4444","stroke-width":2,"stroke-dasharray":"6 4",opacity:0.9})
    );
  }

  // News markers (inside window)
  const bubbleR = 18, newsColor = "#7c3aed";
  const bubbleY = M.top + plotH - (bubbleR + 6);
  const newsElems = [];
  newsEvents.forEach((e, idx) => {
    const li = toLocalIndex(e.t);
    if (li < 0 || li >= n) return;
    const x = xOfIndex(li);
    newsElems.push(
      React.createElement("line", { key:`nline${idx}`, x1:x, y1:M.top, x2:x, y2:bubbleY - bubbleR,
        stroke:newsColor, "stroke-width":1.8, "stroke-dasharray":"3 4", opacity:0.9 }),
      React.createElement("circle", { key:`nb${idx}`, cx:x, cy:bubbleY, r:bubbleR,
        fill:"#fff", stroke:newsColor, "stroke-width":2, opacity:0.4 }),
      React.createElement("text", { key:`ntext${idx}`, x:x, y:bubbleY+5, "text-anchor":"middle",
        className:"fill-gray-900 text-[14px] font-bold noselect" }, "N")
    );
  });

  // Trade markers (triangles), only those inside window
  const tradeElems = trades.map((tr,idx)=>{
    const li = toLocalIndex(tr.t);
    if (li < 0 || li >= n) return null;
    const x = xOfIndex(li), y = yOf(tr.price);
    const isBuy = tr.side==="BUY";
    const s = 6;
    const points = isBuy
      ? `${x},${y-s} ${x-s},${y+s} ${x+s},${y+s}`
      : `${x},${y+s} ${x-s},${y-s} ${x+s},${y-s}`;
    return React.createElement("polygon",{key:`tr${idx}`,points,fill:isBuy?"#2563eb":"#ef4444",opacity:0.9,stroke:"#0f172a","stroke-width":0.5});
  }).filter(Boolean);

  // Unique clipPath id
  const clipId = React.useMemo(() => `clipInner_${Math.random().toString(36).slice(2)}`, []);

  // Children groups
  const gridAndAxes = [
    // border axes lines
    React.createElement("line",{key:"axX",x1:M.left,y1:M.top+plotH,x2:M.left+plotW,y2:M.top+plotH,stroke:"#e5e7eb","stroke-width":1}),
    React.createElement("line",{key:"axY",x1:M.left,y1:M.top,x2:M.left,y2:M.top+plotH,stroke:"#e5e7eb","stroke-width":1}),
    ...yTicks,
    ...fvElems,
    React.createElement("text",{key:"ticks",x:M.left+plotW,y:M.top+12,"text-anchor":"end",className:"fill-gray-500 text-[11px] noselect"}, `ticks: ${n}`)
  ];

  const seriesGroup = [
    React.createElement("polyline",{key:"ply1",points:pts,fill:"none",stroke:"#0f172a","stroke-width":1.8,"stroke-opacity":0.5}),
    React.createElement("polyline",{key:"ply2",points:recentPts,fill:"none",stroke:"#000","stroke-width":2.6,"stroke-opacity":0.95}),
    ...tradeElems,
    ...newsElems,
    ...vwapLine
  ];

  return React.createElement("div",{className:"rounded-2xl border border-slate-200 shadow-sm bg-white chart-card"},
    React.createElement("div",{ref:wrapRef, style:{width:"100%"}},
      React.createElement("svg",{viewBox:`0 0 ${W} ${H}`, style:{width:"100%", height: `${heightPx}px`, display:"block"}},
        [
          React.createElement("defs",{key:"defs"},
            React.createElement("clipPath",{id:clipId},
              React.createElement("rect",{x:M.left,y:M.top,width:plotW,height:plotH})
            )
          ),
          React.createElement("g",{key:"gridAxes"}, gridAndAxes),
          React.createElement("g",{key:"series", clipPath:`url(#${clipId})`}, seriesGroup)
        ]
      )
    )
  );
}
      

// ---------- Macro news: simple per-scenario magnitudes (fairness by total) ----------
// We keep fairness by ensuring each scenario's absolute moves sum to the same target.
// For 120s rounds we use 7 events (15..105s); for 90s rounds we use 5 events (15..75s).

const FAIR_SUM = { 90: 0.32, 120: 0.37 }; // totals must match (abs sum of % moves)
const EPS = 1e-6;

// Helpers to define events with explicit signed magnitudes
const up   = (pct, h, why) => ({ pct:+pct, h, why });
const down = (pct, h, why) => ({ pct:-pct, h, why });
const flat = (h, why)      => ({ pct:0,   h, why });

// NOTE: Each scenario BELOW already includes signed magnitudes.
// Keep the same total |pct| across scenarios to maintain fairness.
const SCENARIOS = [
  {
    id: "war_arc",
    title: "Geopolitical Shock → Tension → De-escalation",
    // 7 events totaling |pct| ≈ 0.37 (for 120s); first 5 total ≈ 0.32 (for 90s)
    events: [
      down(0.12, "Conflict erupts in a key region",
        "Heightened uncertainty and risk-off flows hit global equities; energy prices lift, broader indices fall."),
      down(0.07, "Sanctions & supply concerns rise",
        "Trade disruptions and commodity volatility raise risk premia across markets."),
      flat("Central banks monitor spillovers",
        "Policy-makers signal readiness to act if financial conditions tighten excessively."),
      up(0.04, "Ceasefire talks begin",
        "Hopes for de-escalation modestly improve risk sentiment."),
      down(0.03, "Fresh clashes stall negotiations",
        "Setback injects caution; investors trim risk again."),
      up(0.03, "Humanitarian corridors expand",
        "Tensions ease marginally; equities grind higher."),
      up(0.02, "Framework for ceasefire announced",
        "Diplomatic progress supports a modest relief bid into the close.")
    ]
  },

  {
    id: "inflation_arc",
    title: "Inflation Surprise → Policy Debate → Mixed Data",
    events: [
      up(0.12, "Inflation cools sharply vs. forecasts",
        "Lower inflation reduces expected path of rates; duration and risk assets rally."),
      flat("Fed officials caution against overreaction",
        "Communication tempers exuberance; guidance remains data-dependent."),
      up(0.06, "Retail sales resilient",
        "Soft-landing vibe: growth holds while price pressures cool."),
      down(0.04, "Wage growth re-accelerates",
        "Sticky wage inflation revives hike fears; equities give back some gains."),
      flat("PMIs mixed across regions",
        "Manufacturing soft, services steady; net impact modest."),
      up(0.03, "Core PCE in line",
        "No fresh hawkish surprise; risk sentiment stabilizes upward."),
      up(0.02, "Fed maintains pause",
        "No hike and measured tone keep the soft-landing narrative intact.")
    ]
  },

  {
    id: "banking_arc",
    title: "Bank Stress → Policy Backstop → Stabilization",
    events: [
      down(0.12, "Mid-size bank under severe pressure",
        "Funding concerns trigger risk-off; financials lead declines."),
      down(0.07, "Contagion fears spread",
        "CDS widen; broad de-risking across equities."),
      up(0.06, "Liquidity backstop announced",
        "Emergency lending facility eases funding stress; markets rebound."),
      flat("Supervisors intensify reviews",
        "Uncertainty persists, but systemic safeguards are emphasized."),
      up(0.03, "Stronger bank capital data",
        "Improved confidence nudges indices higher."),
      down(0.03, "Isolated downgrades hit sentiment",
        "Idiosyncratic issues keep volatility elevated."),
      up(0.02, "Deposits stabilize at regionals",
        "Signs of normalization support a modest grind higher.")
    ]
  },

  // Example of an extra scenario with the SAME totals (feel free to add more):
  {
    id: "china_growth_arc",
    title: "China Growth Scare → Stimulus Hopes → Targeted Support",
    events: [
      down(0.12, "China growth data disappoints sharply",
        "Global cyclicals and commodities sell off; broader indices weaken."),
      flat("State media hints at policy review",
        "Investors weigh the chance of targeted easing; uncertainty remains."),
      up(0.06, "Targeted fiscal support flagged",
        "Infrastructure and housing measures lift risk appetite modestly."),
      down(0.04, "Property developer defaults",
        "Credit worries resurface; momentum pares back."),
      flat("Export orders stabilize",
        "Signs of a floor but no decisive turn; limited market impact."),
      up(0.03, "Reserve requirement cut floated",
        "Liquidity backdrop improves; equities firm."),
      up(0.02, "RRR cut confirmed",
        "Easier financial conditions support a mild relief bid.")
    ]
  }
];

// Trim a scenario to match duration & check fairness.
function scenarioForDuration(scn, durSeconds){
  const expectedEvents = Math.max(1, Math.floor(durSeconds/15) - 1); // 90s→5, 120s→7
  const trimmed = { ...scn, events: scn.events.slice(0, expectedEvents) };

  // Fairness check: abs sum should match target for the duration
  const target = FAIR_SUM[durSeconds] ?? FAIR_SUM[120];
  const sumAbs = trimmed.events.reduce((s,e)=>s+Math.abs(e.pct), 0);
  if (Math.abs(sumAbs - target) > EPS) {
    console.warn(`Fairness sum mismatch for ${scn.id} @${durSeconds}s. got=${sumAbs.toFixed(3)} want=${target.toFixed(3)}`);
  }
  return trimmed;
}


      // ---------- Fullscreen helpers ----------
      async function enterFullscreen(){ const el=document.documentElement; if(el.requestFullscreen) return el.requestFullscreen(); if(el.webkitRequestFullscreen) return el.webkitRequestFullscreen(); }
      async function exitFullscreen(){ if(document.exitFullscreen) return document.exitFullscreen(); if(document.webkitExitFullscreen) return document.webkitExitFullscreen(); }

      // ---------- Shared subcomponents ----------
      function NewsStrip({ headline, mode }){
        const colored = (mode === "easy");
        const base = "p-3 rounded-2xl border shadow-sm";
        const klass = headline
          ? (colored
              ? (headline.pct>0? "bg-emerald-50 border-emerald-300" : (headline.pct<0? "bg-rose-50 border-rose-300" : "bg-slate-50 border-slate-300"))
              : "bg-white border-slate-200")
          : "bg-white border-slate-200";
        return React.createElement("div", { className:`${base} ${klass}`, style:{minHeight:64}}, [
          React.createElement("div",{key:"a",className:"text-sm font-semibold"}, headline ? (colored ? (headline.pct>0?"▲ Positive macro":headline.pct<0?"▼ Negative macro":"→ Neutral macro") : "News") : "News"),
          React.createElement("div",{key:"b",className:"text-sm"}, headline ? headline.h : "Waiting for news…"),
          React.createElement("div",{key:"c",className:"text-xs text-gray-700 mt-1"}, headline ? `${headline.why}${headline.pct===0 ? "" : ` — fair value ${(headline.pct*100).toFixed(0)}%.`}` : "Headlines drop every 15 seconds.")
        ]);
      }

      function StatCard({label,children,muted}){
        return React.createElement("div", { className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white" }, [
          React.createElement("div", { className:"text-[13px] text-gray-500" }, label),
          React.createElement("div", { className:"text-[22px] font-semibold" }, children),
          muted && React.createElement("div", { className:"text-[12px] text-gray-500 mt-1" }, muted)
        ]);
      }

      // ---------- Game ----------
      function Game(){
        const isMobile = useIsMobile(640); // treat <=640px as mobile for layout

        // screens & mode
        const [screen, setScreen] = useState("welcome");
        const [mode, setMode] = useState("normal"); // "normal" | "easy"
        const [player, setPlayer] = useState(localStorage.getItem("player_name") || "");
        const [duration, setDuration] = useState(120); // visible; enforced on start by mode
        const [timeLeft, setTimeLeft] = useState(120);
        const [kiosk, setKiosk] = useState(false);

        // layout (desktop only uses this): Fit width toggle
        const [wide, setWide] = useState(true);
        const containerClass = wide
          ? "mx-auto w-full px-4 md:px-8 xl:px-12 2xl:px-16 max-w-[1500px] 2xl:max-w-[1800px]"
          : "mx-auto w-full px-4 max-w-6xl";

        // sound
        const [soundOn, setSoundOn] = useState(localStorage.getItem("sound_on")==="1");
        async function enableSound(){ try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); await audioCtx.resume(); setSoundOn(true); localStorage.setItem("sound_on","1"); }catch{} }

        useEffect(()=>{ localStorage.setItem("player_name", player||""); },[player]);

        // market state
        const [mid, _setMid] = useState(100);
        const [fair, _setFair] = useState(100);
        const [spread] = useState(0.10);

        // liquidity/impact params
        const BASE_DEPTH = 1000;
        const [availDepth, _setAvailDepth] = useState(BASE_DEPTH);
        const REPLENISH_PER_SEC = 0.10;
        const IMPACT_MIN = 0.005, IMPACT_MAX = 0.90, IMPACT_CURVE_POW = 2.2, LIQ_POWER = 0.5;

        // randomness
        const SIGMA_CALM_PCT = 0.0015, SIGMA_VOL_PCT = 0.0030;
        const JUMP_PROB_TICK = 0.001, JUMP_MIN_PCT = 0.003, JUMP_MAX_PCT = 0.010;

        // session state
        const [cash, _setCash] = useState(100000);
        const [reserve, _setReserve] = useState(0);
        const [pos, _setPos] = useState(0);
        const [tick, setTick] = useState(0);
        const tickRef = useRef(0);
        const [hist, setHist] = useState([{t:0, mid:100}]);
        const [size, setSize] = useState(100);

        const [regime, setRegime] = useState("Calm");
        const [headline, setHeadline] = useState(null);
        const [notice, setNotice] = useState("");

        // pause (Easy: 5s on news)
        const pauseUntilRef = useRef(0);

        // revert boost after big orders
        const [revertTicks, _setRevertTicks] = useState(0);
        const [revertStrength, _setRevertStrength] = useState(0);

        // refs
        const midRef=useRef(100), fairRef=useRef(100), cashRef=useRef(100000), posRef=useRef(0), availRef=useRef(BASE_DEPTH);
        const reserveRef=useRef(0);
        const avgPriceRef=useRef(null);  // VWAP of current net position (null if flat)
        const loopRef=useRef(null), startTimeRef=useRef(null), endTimeRef=useRef(null);
        const scheduleRef=useRef([]), nextNewsIdxRef=useRef(0);
        const revertTicksRef=useRef(0), revertStrengthRef=useRef(0);
	const scenarioRef = useRef(null);      // holds the chosen scenario for the round
	const newsSeqRef  = useRef([]);        // array of events actually used this round
	const lastScenarioIdRef = useRef(null);   // remember last scenario used so we can avoid repeats

        // markers
        const newsEventsRef = useRef([]); // { t }
        const tradesRef = useRef([]);     // { t, price, side }

        // synced setters
        const setMid   = v => { const x=typeof v==="function"?v(midRef.current):v;   midRef.current=x;   _setMid(x); };
        const setFair  = v => { const x=typeof v==="function"?v(fairRef.current):v;  fairRef.current=x;  _setFair(x); };
        const setCash  = v => { const x=typeof v==="function"?v(cashRef.current):v;  cashRef.current=x;  _setCash(x); };
        const setReserve = v => { const x=typeof v==="function"?v(reserveRef.current):v; reserveRef.current=x; _setReserve(x); };
        const setPos   = v => { const x=typeof v==="function"?v(posRef.current):v;   posRef.current=x;   _setPos(x); };
        const setAvail = v => { const x=typeof v==="function"?v(availRef.current):v; availRef.current=x; _setAvailDepth(x); };
        const setRevertTicks = v => { const x=typeof v==="function"?v(revertTicksRef.current):v; revertTicksRef.current=x; _setRevertTicks(x); };
        const setRevertStrength = v => { const x=typeof v==="function"?v(revertStrengthRef.current):v; revertStrengthRef.current=x; _setRevertStrength(x); };

        const total = cashRef.current + reserveRef.current + posRef.current*midRef.current;
        const pnl = total - 100000;
        const pnlColor = pnl>0?"text-green-600":(pnl<0?"text-rose-600":"text-gray-900");

        // drift toward FV (+ optional revert boost)
        function driftTowardFair(){
          const d = fairRef.current - midRef.current;
          const baseFactor = clamp(Math.abs(d)/10, 0, 1);
          const BETA_PER_SEC = 0.35;
          const betaTick = BETA_PER_SEC / 10; // 10Hz base
          let drift = betaTick * d * baseFactor;
          if (revertTicksRef.current > 0) {
            drift += revertStrengthRef.current * Math.sign(d) * Math.min(1, Math.abs(d)/0.5);
            setRevertTicks(t => t - 1);
            setRevertStrength(s => s * 0.6);
          }
          return clamp(drift, -0.12, +0.12);
        }

        function triggerRevertBoost(qty){
          if (qty >= 500) {
            const deviation = fairRef.current - midRef.current;
            const strength = 0.08 * (qty/1000) * (Math.abs(deviation)/1.0);
            setRevertStrength(strength);
            setRevertTicks(5);
          }
        }

        function resetRound(){
          setMid(100); setFair(100);
          setCash(100000); setReserve(0); setPos(0);
          setTick(0); tickRef.current = 0;
          setHist([{t:0, mid:100}]);
          setRegime("Calm"); setHeadline(null); setNotice("");
          setAvail(BASE_DEPTH);
          setRevertTicks(0); setRevertStrength(0);
          pauseUntilRef.current = 0;
          newsEventsRef.current = [];
          tradesRef.current = [];
          avgPriceRef.current = null;
        }

        async function toggleFullscreen(){
          try {
            if (!document.fullscreenElement) { await enterFullscreen(); setKiosk(true); }
            else { await exitFullscreen(); setKiosk(false); }
          } catch(e){}
        }

        function buildNewsSchedule(startMs, durSeconds){
          const last = durSeconds - 15;
          const arr = [];
          for (let s=15; s<=last; s+=15) arr.push(startMs + s*1000);
          return arr;
        }

function start(){
  if (!player.trim()) return alert("Enter a name to start!");
  resetRound();

  const dur = (mode === "easy") ? 90 : 120;
  setDuration(dur);
  setTimeLeft(dur);

  // Pick a scenario at random and trim it to match duration (5 or 7 events)
  const pickedScn = SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)];
  const trimmed   = scenarioForDuration(pickedScn, dur);

  // Keep for this round
  scenarioRef.current = trimmed;
  newsSeqRef.current  = trimmed.events.slice();

  setScreen("play");

  const startMs = Date.now();
  startTimeRef.current = startMs;
  endTimeRef.current   = startMs + dur * 1000;

  // Strict 15s schedule: 15,30,...,(dur-15)
  scheduleRef.current = (function buildNewsSchedule(sMs, dSec){
    const last = dSec - 15;
    const arr = [];
    for (let s = 15; s <= last; s += 15) arr.push(sMs + s * 1000);
    return arr;
  })(startMs, dur);

  // Ensure schedule length matches events count (trim if needed)
  if (scheduleRef.current.length > newsSeqRef.current.length) {
    scheduleRef.current = scheduleRef.current.slice(0, newsSeqRef.current.length);
  }

  nextNewsIdxRef.current = 0;
}
        function pauseFor(ms){
          const now = Date.now();
          pauseUntilRef.current = Math.max(pauseUntilRef.current, now + ms);
          endTimeRef.current += ms;
          for (let i = nextNewsIdxRef.current; i < scheduleRef.current.length; i++){
            scheduleRef.current[i] += ms;
          }
        }

// main loop
useEffect(() => {
  if (screen !== "play") return;
  if (loopRef.current) clearInterval(loopRef.current);

  const intervalMs = mode === "easy" ? 125 : 100; // ~8Hz vs 10Hz

  loopRef.current = setInterval(() => {
    const now = Date.now();

    // respect Easy-mode pause window
    if (now < pauseUntilRef.current) {
      setTimeLeft(Math.max(0, Math.ceil((endTimeRef.current - now) / 1000)));
      return;
    }

    // update visible countdown
    const left = Math.max(0, Math.ceil((endTimeRef.current - now) / 1000));
    setTimeLeft(left);

    // random move + drift toward FV
    const sigmaPct = regime === "Calm" ? SIGMA_CALM_PCT : SIGMA_VOL_PCT;
    const sigmaAbs = fairRef.current * sigmaPct;
    let randomShock = (Math.random() * 2 - 1) * sigmaAbs;

    if (Math.random() < JUMP_PROB_TICK) {
      const jMagPct = JUMP_MIN_PCT + Math.random() * (JUMP_MAX_PCT - JUMP_MIN_PCT);
      randomShock += (Math.random() < 0.5 ? -1 : 1) * fairRef.current * jMagPct;
    }

    const step = randomShock + driftTowardFair();

    // advance mid/tick/history
    setMid(m => {
      const nm = Math.max(1, m + step);
      setTick(t => {
        const t2 = t + 1;
        tickRef.current = t2;
        setHist(h => [...h, { t: t2, mid: nm }].slice(-700));
        return t2;
      });
      return nm;
    });

    // refill liquidity & occasionally flip regime
    const repl = BASE_DEPTH * (REPLENISH_PER_SEC * (intervalMs / 1000));
    setAvail(a => clamp(a + repl, 50, BASE_DEPTH));
    if (Math.random() < 0.03) setRegime(r => (r === "Calm" ? "Volatile" : "Calm"));

   // === SCENARIO NEWS ONLY (no random pickNews) ===
{
  const idx = nextNewsIdxRef.current;
  if (idx < scheduleRef.current.length && now >= scheduleRef.current[idx]) {
    const seq = newsSeqRef.current || [];
    const n = seq[idx]; // { h, why, pct }

    if (n) {
      // Update headline
      setHeadline({ h: n.h, why: n.why, pct: n.pct });

      // Sounds
      if (soundOn) {
        if (n.pct > 0) beep(740, 0.18, "sine", 0.03);
        else if (n.pct < 0) beep(330, 0.18, "sine", 0.03);
        else beep(520, 0.12, "sine", 0.02);
      }

      // Store for end-screen scoring
      newsEventsRef.current.push({
        t: tickRef.current,
        price: midRef.current,
        pct: n.pct,
        dir: Math.sign(n.pct),             // +1 / 0 / -1
        pauseMs: (mode === "easy" ? 5000 : 0)
      });

      // Move fair value by scripted %
      if (n.pct !== 0) setFair(f => Math.max(1, f * (1 + n.pct)));

      // Advance & optional pause
      nextNewsIdxRef.current = idx + 1;
      if (mode === "easy") pauseFor(5000);
    } else {
      // No event found at this slot (safety)
      nextNewsIdxRef.current = idx + 1;
    }
  }
}

   // === End-of-round ===
    if (left <= 0) {
      clearInterval(loopRef.current); loopRef.current = null;

      const finalTotal = cashRef.current + reserveRef.current + posRef.current * midRef.current;
      const finalPnl = finalTotal - 100000;

      if (soundOn) {
        if (finalPnl > 0) chord([523.25, 659.25, 783.99], 0.6, 0.025);
        else chord([196.00, 233.08, 261.63], 0.6, 0.025);
      }

      if (mode === "normal") {
        const lb = loadLB();
        const entry = { name: player.trim(), pnl: Number(finalPnl.toFixed(2)), total: Number(finalTotal.toFixed(2)), ts: now };
        const next = [...lb, entry].sort((a,b)=>b.pnl-a.pnl).slice(0,50);
        saveLB(next);
      }

      setScreen("end");
    }
  }, intervalMs);                        // <-- closes setInterval(...)
                                          //     and its callback: () => { ... }

  // cleanup on effect re-run/unmount
  return () => {
    if (loopRef.current) {
      clearInterval(loopRef.current);
      loopRef.current = null;
    }
  };
}, [screen, duration, regime, soundOn, mode]);  // <-- closes useEffect(...)

        // ----- VWAP helper (FIXED: pass old position) -----
        function updateAvgPriceAfterTrade(pOld, side, qty, vwap){
          const pNew = side==="BUY" ? pOld + qty : pOld - qty;

          if (pOld === 0){
            avgPriceRef.current = vwap;                // first position shows immediately
          } else if (Math.sign(pOld) === Math.sign(pNew)){
            if (Math.abs(pNew) > Math.abs(pOld)){
              avgPriceRef.current = (Math.abs(pOld)*avgPriceRef.current + qty*vwap) / Math.abs(pNew);
            }
          } else {
            const crossQty = Math.abs(pNew);
            avgPriceRef.current = crossQty > 0 ? vwap : null;
          }
          if (pNew === 0) avgPriceRef.current = null;
        }

        // trading
        function trade(side){
          if (screen!=="play") return;
          const reqQty = Math.max(1, Math.round(size));
          const sgn = side==="BUY" ? +1 : -1;

          const pOld = posRef.current;

          const maxAdd = (sgn>0) ? MAX_POS - pOld : MAX_POS + pOld;
          const qty = clamp(reqQty, 0, Math.max(0, maxAdd));
          if (qty === 0) { setNotice(`Position limit reached (±${MAX_POS} sh).`); setTimeout(()=>setNotice(""), 1200); return; }

          const startMid = midRef.current;
          const aD = Math.max(50, availRef.current);
          const after100 = Math.max(0, qty - 100);
          const x = after100 / 900;
          const curve = Math.pow(x, IMPACT_CURVE_POW);
          const liquidityFactor = Math.pow(BASE_DEPTH / aD, LIQ_POWER);
          const impactMag = (IMPACT_MIN + (IMPACT_MAX - IMPACT_MIN) * curve) * liquidityFactor;
          const impact = sgn * impactMag;
          const endMid = Math.max(1, startMid + impact);

          const vwap =
            side==="BUY"
              ? (startMid + 0.05) + 0.5 * (endMid - startMid)
              : (startMid - 0.05) + 0.5 * (endMid - startMid);

          const notional = qty * vwap;
          const fee = notional * 0.0001;

          // VWAP first (uses pOld)
          updateAvgPriceAfterTrade(pOld, side, qty, vwap);

          if (side==="BUY") {
            setCash(c=>c - fee);
            if (pOld < 0) {
              setReserve(r => { const r2 = r - notional; if (r2 >= 0) return r2; setCash(c => c + r2); return 0; });
            } else {
              setCash(c=>c - notional);
            }
            setPos(p=>p + qty);
          } else {
            setCash(c=>c - fee);
            if (pOld > 0) setCash(c=>c + notional);
            else setReserve(r=>r + notional);
            setPos(p=>p - qty);
          }

          setTimeout(() => {
            if (posRef.current >= 0 && reserveRef.current > 0) {
              setCash(c => c + reserveRef.current);
              setReserve(0);
            }
          }, 0);

          if (soundOn) { side==="BUY" ? chirp(420,880,0.18) : chirp(880,420,0.18); }
          if (navigator.vibrate) navigator.vibrate(15);

          setMid(endMid);
          setTick(t => {
            const t2 = t + 1;
            tickRef.current = t2;
            setHist(h=>[...h, {t:t2, mid:endMid}].slice(-700));
            return t2;
          });
          tradesRef.current.push({ t: tickRef.current, price: endMid, side, size: qty });



          setAvail(a => clamp(a - qty, 50, BASE_DEPTH));
          triggerRevertBoost(qty);
        }

        // ---------- Desktop & Mobile Layouts ----------
        const totalVal = cashRef.current + reserveRef.current + posRef.current * midRef.current;
        const posAvg = avgPriceRef.current;
        const posSide = Math.sign(posRef.current);

        // Desktop header right controls
        const headerRight = React.createElement("div", { className:"flex items-center gap-2" }, [
          React.createElement("span", { key:"rg", className:"px-2 py-1 rounded-full text-xs border bg-white" }, regime),
          React.createElement("span", { key:"tm", className:"px-2 py-1 rounded-full text-xs border bg-white" }, `⏱ ${timeLeft}s`),
          React.createElement("span", { key:"tk", className:"px-2 py-1 rounded-full text-xs border bg-white" }, (mode==="easy"?"Easy":"Normal")+" · "+TICKER),
          React.createElement("button", { key:"sd", onClick: enableSound, className: "px-2 py-1 rounded-full text-xs border bg-white" }, soundOn ? "🔊" : "🔇"),
          React.createElement("button", { key:"fs", onClick: async()=>{ await toggleFullscreen(); }, className: "px-2 py-1 rounded-full text-xs border bg-white" }, document.fullscreenElement ? "⤢" : "⤢"),
          React.createElement("button", { key:"wd", onClick: () => setWide(w => !w), className: "px-2 py-1 rounded-full text-xs border bg-white" }, wide ? "↔ Compact" : "⤢ Fit width")
        ]);

        function DesktopLayout(){
          return React.createElement("div", { className: containerClass + " space-y-4" }, [
            React.createElement("header", { key:"p0", className:"flex items-center justify-between" },
              [
                React.createElement("div", { key:"p0a", className:"flex items-center gap-3" }, [
                  React.createElement(Brand, { size: 32, withText: false, key:"brand" }),
                  React.createElement("div", { className:"text-xl font-semibold" }, `Trader: ${player}`)
                ]),
                headerRight
              ]
            ),
            React.createElement(NewsStrip, { key:"nb", headline, mode }),
            React.createElement("div", { key:"stats", className:"grid md:grid-cols-6 gap-3 xl:gap-4" }, [
              React.createElement(StatCard, { key:"s1", label:"Mid", muted:"Spread "+fmt2(0.10) }, "$"+fmt2(midRef.current)),
              React.createElement(StatCard, { key:"s2", label:"Fair Value", muted:"Anchors drift" }, "$"+fmt2(fairRef.current)),
              React.createElement(StatCard, { key:"s3", label:"Position", muted:"Cap ±"+MAX_POS }, `${posRef.current} sh`),
              React.createElement(StatCard, { key:"s4", label:"Cash" }, "$"+cashRef.current.toLocaleString()),
              React.createElement("div", { key:"s5", className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white" }, [
                React.createElement("div", { className:"text-[13px] text-gray-500" }, "P&L (MTM)"),
                React.createElement("div", { className:`text-[22px] font-semibold ${pnlColor}` }, "$"+fmt2(pnl)),
                React.createElement("div", { className:"text-[12px] text-gray-500 mt-1" }, "Total $"+totalVal.toLocaleString())
              ]),
              React.createElement("div", { key:"s6", className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white flex items-center justify-center gap-2" }, [
                React.createElement("button", { onClick: enableSound, className: "px-3 py-2 rounded-xl border shadow-sm text-sm btn hover:bg-slate-50" }, (soundOn ? "🔊 Sound on" : "🔇 Enable sound")),
                React.createElement("button", { onClick: async()=>{ try{ if(!document.fullscreenElement){ await enterFullscreen(); setKiosk(true);} else { await exitFullscreen(); setKiosk(false);} }catch{} }, className: "px-3 py-2 rounded-xl border shadow-sm text-sm btn hover:bg-slate-50" }, document.fullscreenElement ? "⤢ Exit Fullscreen" : "⤢ Fullscreen")
              ])
            ]),
            notice && React.createElement("div", { key:"nt", className:"text-xs text-rose-700" }, notice),
            React.createElement(PriceChart, {
              key:"ch",
              data: hist,
              fairLine: fairRef.current,
              heightVhDesktop: 38,
              heightVhMobile: 50,
              newsEvents: newsEventsRef.current,
              trades: tradesRef.current,
              posAvg,
              posSide
            }),
            React.createElement("div", { key:"ctl", className:"grid md:grid-cols-3 gap-3 xl:gap-4 items-end" }, [
              React.createElement("div", { className:"p-4 rounded-2xl border border-slate-200 shadow-sm bg-white space-y-3" }, [
                React.createElement("div", { className:"text-sm font-semibold" }, "Trade"),
                React.createElement("label", { className:"text-xs text-gray-500" }, "Order size (shares)"),
                React.createElement("input", { type:"number", min:1, step:1, value:size, onChange:e=>setSize(clamp(Number(e.target.value)||0, 1, 1000000)), className:"w-full border rounded-xl px-3 py-2" }),
                React.createElement("div", { className:"grid grid-cols-2 gap-2" }, [
                  React.createElement("button", { onClick:()=>trade("SELL"), className:"px-3 py-2 rounded-xl border shadow-sm font-medium btn hover:bg-rose-50" }, "SELL"),
                  React.createElement("button", { onClick:()=>trade("BUY"),  className:"px-3 py-2 rounded-xl border shadow-sm font-medium btn hover:bg-emerald-50" }, "BUY")
                ]),
                React.createElement("div", { className:"flex justify-between text-xs text-gray-500" },
                  React.createElement("div", null, "Fee: 0.01% notional"),
                  React.createElement("div", null, `Pos cap: ±${MAX_POS} sh · Liquidity refills each tick`)
                )
              ]),
              React.createElement("div", { className:"p-4 rounded-2xl border border-slate-200 shadow-sm bg-white space-y-3" }, [
                React.createElement("div", { className:"text-sm font-semibold" }, "Round Controls"),
                React.createElement("button", { onClick:()=>{ if(confirm("End round now?")){ endTimeRef.current = Date.now(); } }, className:"px-3 py-2 rounded-xl border shadow-sm font-medium btn hover:bg-slate-50" }, "End Round"),
                React.createElement("div", { className:"text-xs text-gray-500" }, mode==="easy"
                  ? "Easy: colored news, 5s pause on headlines, slower ticks."
                  : "Normal: no assists, full speed, leaderboard.")
              ]),
              React.createElement("div", { className:"p-4 rounded-2xl border border-slate-200 shadow-sm bg-white space-y-2" }, [
                React.createElement("div", { className:"text-sm font-semibold" }, "How to win"),
                React.createElement("ul", { className:"list-disc list-inside text-sm text-gray-700 space-y-1" }, [
                  React.createElement("li", { key:"h1" }, "Watch Fair Value moves on news (dashed line)."),
                  React.createElement("li", { key:"h2" }, "Slice orders across ticks to reduce impact."),
                  React.createElement("li", { key:"h3" }, "Follow your VWAP line to manage risk."),
                  React.createElement("li", { key:"h4" }, "Keep an eye on the position cap.")
                ])
              ])
            ])
          ]);
        }
function MobileLayout(){
  return React.createElement("div", { className:"mx-auto w-full px-3 space-y-3" }, [

    // Header: logo, timer/mode, fullscreen icon
    React.createElement("header", { key:"m0", className:"flex items-center justify-between" }, [
      React.createElement(Brand, { key:"b", size: 28, withText: false }),
      React.createElement("div", { key:"rt", className:"flex items-center gap-2 text-xs" }, [
        React.createElement("span", { className:"px-2 py-1 rounded-full border bg-white" }, `⏱ ${timeLeft}s`),
        React.createElement("span", { className:"px-2 py-1 rounded-full border bg-white" }, (mode==="easy"?"Easy":"Normal")),
        // Fullscreen icon button (mobile)
        React.createElement("button", {
          className:"px-2 py-1 rounded-full border bg-white btn",
          onClick: async ()=>{ try { await toggleFullscreen(); } catch(e){} }
        }, "⤢")
      ])
    ]),

    React.createElement(NewsStrip, { key:"nb", headline, mode }),

    // Chart
    React.createElement(PriceChart, {
      key:"ch",
      data: hist,
      fairLine: fairRef.current,
      mobileWindowPct: 0.60,
      newsEvents: newsEventsRef.current,
      trades: tradesRef.current,
      posAvg: avgPriceRef.current,
      posSide: Math.sign(posRef.current)
    }),

    // Quick stats
    React.createElement("div", { key:"quick", className:"grid grid-cols-2 gap-2" }, [
      React.createElement("div", { className:"p-2 rounded-xl border bg-white text-center" }, [
        React.createElement("div", { className:"text-[12px] text-gray-500" }, "Position"),
        React.createElement("div", { className:"text-lg font-semibold" }, `${posRef.current} sh`)
      ]),
      React.createElement("div", { className:"p-2 rounded-xl border bg-white text-center" }, [
        React.createElement("div", { className:"text-[12px] text-gray-500" }, "P&L"),
        React.createElement("div", { className:`text-lg font-semibold ${pnlColor}` }, "$"+fmt2(pnl))
      ])
    ]),

    // Trade card with BIG fullscreen toggle
    React.createElement("div", { key:"trade", className:"p-3 rounded-2xl border bg-white space-y-3" }, [
      React.createElement("div", { className:"flex items-center justify-between" }, [
        React.createElement("div", { className:"text-sm font-semibold" }, "Trade"),
        React.createElement("button", {
          className:"text-xs px-3 py-2 rounded-xl border shadow-sm btn",
          onClick: async ()=>{ try { await toggleFullscreen(); } catch(e){} }
        }, (document.fullscreenElement ? "⤢ Exit Fullscreen" : "⤢ Fullscreen"))
      ]),

      React.createElement("input", {
        className:"w-full border rounded-xl px-3 py-2",
        type:"number", min:1, step:1, value:size,
        onChange:e=>setSize(clamp(Number(e.target.value)||0, 1, 1000000)),
        placeholder:"Size"
      }),

      // BIG stacked buttons (thumb-friendly)
      React.createElement("button", {
        onClick:()=>trade("BUY"),
        className:"w-full px-4 py-3 rounded-xl border shadow-sm font-semibold btn bg-emerald-50 text-lg"
      }, "BUY"),

      React.createElement("button", {
        onClick:()=>trade("SELL"),
        className:"w-full px-4 py-3 rounded-xl border shadow-sm font-semibold btn bg-rose-50 text-lg"
      }, "SELL"),

      React.createElement("div", { className:"text-[11px] text-gray-500" }, "Fee 0.01% · Pos cap ±"+MAX_POS)
    ])
  ]);
}


// ---------- Screens ----------
if (screen==="welcome"){
  const lb = loadLB();
  const leader = (lb.length===0
    ? React.createElement("div", { className:"text-sm text-gray-500" }, "No scores yet — be the first!")
    : React.createElement("ol", { className:"text-sm space-y-1" },
        lb.slice(0,10).map((r,i)=>
          React.createElement("li", { key:i, className:"flex justify-between" },
            React.createElement("span", null, `${i+1}. ${r.name}`),
            React.createElement("span", { className:r.pnl>0?"text-green-600":(r.pnl<0?"text-rose-600":"") }, `$${fmt2(r.pnl)}`)
          )
        )
      )
  );

  const modeBox = React.createElement("div", { className:"grid md:grid-cols-2 gap-3 xl:gap-4" }, [
    React.createElement("label", { key:"m1", className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white flex gap-3 cursor-pointer" },
      React.createElement("input", { type:"radio", name:"mode", className:"mt-1", checked: mode==="easy", onChange:()=>setMode("easy") }),
      React.createElement("div", null,
        React.createElement("div", { className:"font-semibold" }, "Easy"),
        React.createElement("div", { className:"text-sm text-gray-600" }, "Colored news cues, auto-pause 5s on headlines, ~20% slower ticks. No leaderboard.")
      )
    ),
    React.createElement("label", { key:"m2", className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white flex gap-3 cursor-pointer" },
      React.createElement("input", { type:"radio", name:"mode", className:"mt-1", checked: mode==="normal", onChange:()=>setMode("normal") }),
      React.createElement("div", null,
        React.createElement("div", { className:"font-semibold" }, "Normal"),
        React.createElement("div", { className:"text-sm text-gray-600" }, "No assists, no pauses, full-speed ticks. Leaderboard enabled.")
      )
    )
  ]);

  const wrapperClass = isMobile ? "mx-auto w-full px-3 space-y-6"
    : ( (wide ? "mx-auto w-full px-4 md:px-8 xl:px-12 2xl:px-16 max-w-[1500px] 2xl:max-w-[1800px]"
              : "mx-auto w-full px-4 max-w-6xl") + " space-y-6");

  return React.createElement("div", { className: wrapperClass }, [
    React.createElement("div", { key:"brand", className:"flex items-center justify-between" }, [
      React.createElement(Brand, { size: isMobile?36:44, withText: true, text: "Welcome Fair — Trading Game" }),
      !isMobile && React.createElement("button", {
        onClick: () => setWide(w => !w),
        className:"px-3 py-2 rounded-xl border shadow-sm text-sm btn bg-white"
      }, wide ? "↔ Compact" : "⤢ Fit width")
    ]),
    React.createElement("div", { key:"intro", className:"text-sm text-gray-700 p-3 rounded-2xl border border-slate-200 bg-white shadow-sm" },
      "Pick a mode: ", React.createElement("b", null, "Easy"),
      " gives colored news cues, auto-pauses for 5s on headlines, and runs slower so beginners can think. ",
      React.createElement("b", null, "Normal"),
      " removes assists and pauses, runs full-speed, and feeds the leaderboard. ",
      "Normal rounds are 2 minutes. Easy rounds are 90s (pauses don’t eat into that time)."
    ),
    modeBox,
    React.createElement("div", { key:"start", className:"p-4 rounded-2xl border border-slate-200 shadow-sm bg-white grid md:grid-cols-3 gap-3 xl:gap-4 items-end" }, [
      React.createElement("div", { key:"w1a" },
        React.createElement("label", { className:"text-xs text-gray-500" }, "Your name"),
        React.createElement("input", { value:player, onChange:e=>setPlayer(e.target.value),
          className:"w-full border rounded-xl px-3 py-2 mt-1", placeholder:"e.g., Alex" })
      ),
      React.createElement("div", { key:"w1b" },
        React.createElement("label", { className:"text-xs text-gray-500" }, "Round duration (overridden by mode)"),
        React.createElement("input", { type:"number", min:60, step:15, value:duration,
          onChange:e=>setDuration(clamp(Number(e.target.value)||120, 60, 600)),
          className:"w-full border rounded-xl px-3 py-2 mt-1" })
      ),
      React.createElement("div", { key:"w1c", className:"flex flex-col sm:flex-row gap-2 w-full" }, [
  // Start Round (always large)
  React.createElement("button", {
    onClick: start,
    className:"w-full sm:w-auto px-4 py-3 rounded-xl border shadow-sm font-semibold btn hover:bg-emerald-50"
  }, "Start Round"),

  // Sound toggle (keeps smaller style)
  React.createElement("button", {
    onClick: enableSound,
    className:"px-3 py-2 rounded-xl border shadow-sm text-sm btn hover:bg-slate-50"
  }, soundOn ? "🔊 Sound on" : "🔇 Enable sound"),

  // Fullscreen button: big on mobile, small on desktop
  (isMobile
    ? React.createElement("button", {
        onClick: async()=>{ await (document.fullscreenElement? exitFullscreen():enterFullscreen()); },
        className:"w-full mt-2 px-4 py-3 rounded-xl border shadow-sm font-semibold btn bg-slate-50"
      }, document.fullscreenElement ? "⤢ Exit Fullscreen" : "⤢ Fullscreen (Kiosk)")
    : React.createElement("button", {
        onClick: async()=>{ await (document.fullscreenElement? exitFullscreen():enterFullscreen()); },
        className:"px-3 py-2 rounded-xl border shadow-sm text-sm btn hover:bg-slate-50"
      }, document.fullscreenElement ? "⤢ Exit Fullscreen" : "⤢ Fullscreen (Kiosk)")
  )
])

    ]),
    React.createElement("div", { key:"lb", className:"p-4 rounded-2xl border border-slate-200 shadow-sm bg-white" }, [
      React.createElement("div", { className:"text-sm font-semibold mb-2 flex items-center gap-2" }, [
        React.createElement(Brand, { size: 20, withText: false }),
        React.createElement("span", null, "Leaderboard (Normal mode) — Top 10")
      ]),
      leader,
      React.createElement("div", { className:"mt-3" },
        React.createElement("button", { onClick:()=>{ if(confirm("Clear leaderboard?")){ saveLB([]); location.reload(); } }, className:"px-3 py-2 rounded-xl border text-xs btn hover:bg-slate-50" }, "Clear Leaderboard")
      )
    ]),
    React.createElement("p", { key:"w3", className:"text-xs text-gray-500" }, "Index proxy: think S&P 500 / FTSE 100 (broad macro sensitivity).")
  ]);
}

if (screen==="play"){
  return isMobile ? MobileLayout() : DesktopLayout();
}

// --- end screen (Performance Summary — replaces leaderboard) ---
// helpers (local to this render)
const clamp01 = x => Math.max(0, Math.min(1, x));
const pct = x => Math.round(x);

// window for first trade after news
const windowTicks = (mode === "easy") ? 80 : 100;

// derive per-news metrics
const items = newsEventsRef.current.map(ne => {
  const tickMs = (mode === "easy") ? 125 : 100;
  const firstTrade = tradesRef.current.find(tr => tr.t > ne.t && tr.t <= ne.t + windowTicks);
  if (!firstTrade) return { reacted:false };
  const deltaTicks = firstTrade.t - ne.t;
  const reactedMs = Math.max(0, deltaTicks * tickMs - (ne.pauseMs || 0));
  let correct = false;
  if (ne.dir > 0 && firstTrade.side === "BUY")  correct = true;
  if (ne.dir < 0 && firstTrade.side === "SELL") correct = true;
  if (ne.dir === 0) correct = true;
  return { reacted:true, reactedMs, correct };
});

const reacted = items.filter(x => x.reacted);
const avgMs = reacted.length ? reacted.reduce((s,x)=>s+x.reactedMs,0)/reacted.length : null;
let reactionScore = 50;
if (avgMs != null){
  const sec = avgMs/1000;
  reactionScore = (sec<=1) ? 100 : Math.max(0, Math.round(100 - 20*(sec-1)));
}
const accuracyScore = reacted.length ? pct( reacted.filter(x=>x.correct).length / reacted.length * 100 ) : 50;

// Risk/Confidence: time-weighted |position|
const totalTicks = Math.max(1, tickRef.current);
let twPos = 0, curPos = 0, lastTick = 0;
const sortedTrades = [...tradesRef.current].sort((a,b)=>a.t-b.t);
for (const tr of sortedTrades){
  const dur = Math.max(0, tr.t - lastTick);
  twPos += dur * Math.abs(curPos);
  const sz = (typeof tr.size === "number") ? tr.size : 0;
  curPos += (tr.side==="BUY" ? +sz : -sz);
  lastTick = tr.t;
}
const tailDur = Math.max(0, totalTicks - lastTick);
twPos += tailDur * Math.abs(curPos);
const riskScore = pct( clamp01( twPos / (totalTicks * MAX_POS) ) * 100 );

const tips = [];
if (accuracyScore >= 80) tips.push("Great directional trading!");
else if (accuracyScore < 50) tips.push("Work on trading with the macro impulse.");
if (reactionScore < 60) tips.push("React faster to headlines — execute earlier.");
if (riskScore < 50) tips.push("Scale with conviction when the signal is clear.");

const finalTotalText = (cashRef.current + reserveRef.current + posRef.current*midRef.current).toLocaleString();
const finalPnl = (cashRef.current + reserveRef.current + posRef.current*midRef.current) - 100000;

// --- replace loadImage helper with this robust version ---
function loadImage(src){
  return new Promise((resolve, reject) => {
    const img = new Image();
    if (/^https?:/i.test(src)) img.crossOrigin = "anonymous"; // only for remote URLs
    img.onload  = () => resolve(img);
    img.onerror = (e) => reject(new Error("Image load failed: " + src));
    img.src = src;
  });
}

// --- robust share card, auto-fallback if external images taint the canvas ---
async function generateShareCard(opts = { skipImages:false }) {
  const BANNER_PATH = "assets/Business_card_image.png"; // your new banner
  const LOGO_PATH   = "assets/Kent_Invest_Logo.png";    // existing logo

  // Pull a compact price series for sparkline
  const series = (hist && hist.length ? hist : [{mid:100}]).slice(-160).map(d => d.mid);
  const minP = Math.min(...series), maxP = Math.max(...series);
  const range = Math.max(1e-6, maxP - minP);

  const W = 1080, H = 1350, PAD = 60;
  const c = document.createElement("canvas");
  c.width = W; c.height = H;
  const ctx = c.getContext("2d");

  // Background
  const bg = ctx.createLinearGradient(0, 0, 0, H);
  bg.addColorStop(0, "#0f172a"); bg.addColorStop(1, "#111827");
  ctx.fillStyle = bg; ctx.fillRect(0, 0, W, H);

  // Card
  const cardX = PAD, cardY = PAD + 30, cardW = W - PAD*2, cardH = H - PAD*2 - 30;
  roundRect(ctx, cardX, cardY, cardW, cardH, 28);
  ctx.fillStyle = "#ffffff"; ctx.fill();

// Logo (top-left) — 2× size
if (!opts.skipImages) {
  try {
    const logo = await loadImage(LOGO_PATH);
    const LOGO_W = 140, LOGO_H = 140; // was 88×88
    ctx.drawImage(logo, cardX+28, cardY+20, LOGO_W, LOGO_H);
  } catch (e) {
    console.warn("Logo load failed:", e);
  }
}

  // Title
  ctx.fillStyle = "#0f172a";
  ctx.font = "700 40px Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("Welcome Fair — Trading Game", cardX+28+160, cardY+72);

  // Badges
const badgeY = cardY + 120;
drawBadge(ctx, cardX+180, badgeY, (mode==="easy" ? "Easy" : "Normal"));
drawBadge(ctx, cardX+320, badgeY, `Ticker ${TICKER}`);
const _finalPnl = (cashRef.current + reserveRef.current + posRef.current*midRef.current) - 100000;
const pnlColor = (_finalPnl>=0 ? "#059669" : "#dc2626");
drawBadge(ctx, cardX+480, badgeY, `P&L ${_finalPnl>=0 ? "▲" : "▼"} $${fmt2(_finalPnl)}`, pnlColor);


  // Metrics (short names)
  const labels = [
    { label:"Reaction",  val: Math.round(typeof reactionScore === "number" ? reactionScore : 50) },
    { label:"Accuracy",  val: Math.round(typeof accuracyScore === "number" ? accuracyScore : 50) },
    { label:"Exposure",  val: Math.round(typeof riskScore === "number" ? riskScore : 50) }
  ];
  const mX = cardX+28, mY = badgeY + 44, mW = cardW-56, gap = 24;
  const cols = 3, cw = Math.floor((mW - gap*(cols-1)) / cols), ch = 120;
  labels.forEach((m, i) => drawMetric(ctx, mX + i*(cw+gap), mY, cw, ch, m.label, m.val));

  // Sparkline
  const sX = cardX+28, sY = mY + ch + 48, sW = cardW - 56, sH = 210;
  ctx.font = "700 30px Inter, system-ui, -apple-system";
  ctx.fillStyle = "#0f172a";
  ctx.fillText("Session Sparkline", sX, sY - 12);
  roundRect(ctx, sX, sY, sW, sH, 16);
  ctx.fillStyle = "#f8fafc"; ctx.fill();

  if (series.length >= 2){
    ctx.beginPath();
    for (let i=0;i<series.length;i++){
      const t = i/(series.length-1);
      const x = sX + 10 + t * (sW - 20);
      const y = sY + sH - 10 - ((series[i]-minP)/range) * (sH - 20);
      (i===0) ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.strokeStyle = "#0f172a"; ctx.lineWidth = 3; ctx.stroke();
    const g = ctx.createLinearGradient(0, sY, 0, sY + sH);
    g.addColorStop(0, "rgba(15,23,42,0.12)");
    g.addColorStop(1, "rgba(15,23,42,0.00)");
    ctx.fillStyle = g;
    ctx.lineTo(sX + sW - 10, sY + sH - 10);
    ctx.lineTo(sX + 10,       sY + sH - 10);
    ctx.closePath();
    ctx.fill();
  }

  // Coach’s note
  const tipsArr = [];
  if (typeof accuracyScore === "number" && accuracyScore >= 80) tipsArr.push("Great directional trading!");
  else if (typeof accuracyScore === "number" && accuracyScore < 50) tipsArr.push("Trade with the macro impulse.");
  if (typeof reactionScore === "number" && reactionScore < 60) tipsArr.push("Execute earlier after news.");
  if (typeof riskScore === "number" && riskScore < 50) tipsArr.push("Scale with conviction.");
  const coachY = sY + sH + 44;
  ctx.font = "600 28px Inter, system-ui, -apple-system";
  ctx.fillStyle = "#0f172a";
  ctx.fillText("Coach’s Note", sX, coachY);
  ctx.font = "500 26px Inter, system-ui, -apple-system";
  ctx.fillStyle = "#374151";
  const tipLine = (tipsArr.length ? tipsArr.join(" ") : "React faster to headlines — execute earlier. Scale with conviction.");
  ctx.fillText(tipLine.length > 90 ? tipLine.slice(0, 87) + "…" : tipLine, sX, coachY + 36);

  // Banner image (fills remaining space)
  const bannerX = cardX + 28;
  const bannerY = coachY + 36 + 28;
  const bannerW = cardW - 56;
  const bannerBottomPad = 40;
  const bannerH = Math.max(0, cardY + cardH - bannerBottomPad - bannerY);

  if (!opts.skipImages && bannerH > 60) {
  try {
    const banner = await loadImage(BANNER_PATH);

    // Optional soft background behind the image (not a clip; no cropping)
    ctx.fillStyle = "#f8fafc";
    ctx.fillRect(bannerX, bannerY, bannerW, bannerH);

    // Letterbox-fit the image so it is NEVER cropped.
    const iw = banner.width, ih = banner.height;
    const scale = Math.min(bannerW / iw, bannerH / ih);  // contain (no crop)
    const drawW = Math.round(iw * scale);
    const drawH = Math.round(ih * scale);
    const dx = Math.round(bannerX + (bannerW - drawW) / 2);
    const dy = Math.round(bannerY + (bannerH - drawH) / 2);

    // Same simple draw as the logo: just drawImage with width/height — no clipping.
    ctx.drawImage(banner, dx, dy, drawW, drawH);

  } catch (e) {
    console.warn("Banner load failed:", e);
  }
}


  // Footer
  const stamp = new Date().toLocaleString();
  const sig = (function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0;} return ("00000000"+h.toString(16)).slice(-8); })
              (`${player}|${mode}|${fmt2(_finalPnl)}|${reactionScore}|${accuracyScore}|${riskScore}|${stamp}`);
  ctx.font = "400 20px Inter, system-ui, -apple-system";
  ctx.fillStyle = "#6b7280";
  ctx.fillText(`Generated ${stamp} • id:${sig}`, cardX+28, cardY+cardH-24);

  // Try to produce a blob. If it fails due to taint, auto-retry without images.
  try {
    const blob = await new Promise((res, rej) => {
      c.toBlob(b => b ? res(b) : rej(new Error("toBlob returned null")), "image/png", 0.95);
    });
    const url = URL.createObjectURL(blob);
    return { blob, url };
  } catch (err) {
    console.warn("toBlob failed (likely tainted). Retrying without images…", err);
    if (!opts.skipImages) {
      return await generateShareCard({ skipImages:true });
    }
    // As last resort, dataURL
    const dataUrl = c.toDataURL("image/png");
    const byteString = atob(dataUrl.split(",")[1]);
    const mimeString = dataUrl.split(",")[0].split(":")[1].split(";")[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i=0;i<byteString.length;i++) ia[i] = byteString.charCodeAt(i);
    return { blob: new Blob([ab], { type: mimeString }), url: dataUrl };
  }

  // --- helpers ---
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function drawBadge(ctx,x,y,label,color){
    const padX=12, padY=8;
    ctx.font = "600 24px Inter, system-ui, -apple-system";
    const bw = ctx.measureText(label).width + padX*2;
    roundRect(ctx, x, y-26, bw, 36, 18);
    ctx.fillStyle = color || "#eef2ff"; ctx.fill();
    ctx.fillStyle = color ? "#ffffff" : "#4338ca";
    ctx.fillText(label, x+padX, y);
  }
  function drawMetric(ctx,x,y,w,h,label,val){
    roundRect(ctx,x,y,w,h,14); ctx.fillStyle="#f8fafc"; ctx.fill();
    ctx.font="700 26px Inter, system-ui, -apple-system"; ctx.fillStyle="#0f172a"; ctx.fillText(label, x+14, y+32);
    const bx=x+14, by=y+52, bw=w-28, bh=20;
    roundRect(ctx,bx,by,bw,bh,10); ctx.fillStyle="#e5e7eb"; ctx.fill();
    const fw=Math.round(bw*Math.max(0,Math.min(1,val/100)));
    roundRect(ctx,bx,by,fw,bh,10); ctx.fillStyle="#0f172a"; ctx.fill();
    ctx.font="700 28px Inter, system-ui, -apple-system"; ctx.fillStyle="#111827";
    const valText=`${val}%`;
    ctx.fillText(valText, x+w-14-ctx.measureText(valText).width, y+32);
  }
  function drawImageCover(ctx, img, x, y, w, h, radius=0){
    const iw=img.width, ih=img.height, ir=iw/ih, rr=w/h;
    let dw, dh, dx, dy;
    if (ir > rr){ dh=h; dw=dh*ir; dx=x+(w-dw)/2; dy=y; }
    else       { dw=w; dh=dw/ir; dx=x; dy=y+(h-dh)/2; }
    if (radius>0){ roundRect(ctx,x,y,w,h,radius); ctx.save(); ctx.clip(); ctx.drawImage(img, dx, dy, dw, dh); ctx.restore(); }
    else { ctx.drawImage(img, dx, dy, dw, dh); }
  }
}
function drawImageContain(ctx, img, x, y, w, h, radius=0){
  const iw = img.width, ih = img.height, ir = iw/ih, rr = w/h;
  let dw, dh, dx, dy;
  if (ir > rr){           // wider: fit width
    dw = w; dh = dw / ir;
    dx = x; dy = y + (h - dh)/2;
  } else {                // taller: fit height
    dh = h; dw = dh * ir;
    dx = x + (w - dw)/2; dy = y;
  }
  if (radius > 0){
    roundRect(ctx, x, y, w, h, radius);
    ctx.save(); ctx.clip();
    ctx.drawImage(img, dx, dy, dw, dh);
    ctx.restore();
  } else {
    ctx.drawImage(img, dx, dy, dw, dh);
  }
}



async function shareResultsImage(){
  try {
    const { blob, url } = await generateShareCard();
    const file = new File([blob], "trading_score.png", { type:"image/png" });

    // Native share with file (Android/iOS Chrome → WhatsApp works)
    if (navigator.canShare && navigator.canShare({ files:[file] })) {
      await navigator.share({ files:[file], title:"Trading Game Score" });
      return;
    }

    // Fallback: open PNG in new tab (user can save/share manually)
    window.open(url, "_blank");

  } catch(e) {
    console.error("Share failed:", e);
    alert("Unable to generate share image. Please try again.");
  }
}

// tiny bar component
function Bar({label, value, tooltip}){
  return React.createElement("div", { className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white relative" }, [
    React.createElement("div", { className:"flex items-center justify-between text-[13px] text-gray-500 mb-1" }, [
      `${label} — ${Math.round(value)}%`,
      React.createElement("span", { className:"ml-2 text-gray-400 cursor-pointer group relative" }, [
        "ⓘ",
        React.createElement("div", { className:"absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block bg-black text-white text-xs rounded px-2 py-1 whitespace-nowrap z-10" }, tooltip || "")
      ])
    ]),
    React.createElement("div", { className:"w-full bg-slate-200 rounded h-3 overflow-hidden" },
      React.createElement("div", { className:"h-3 bg-slate-900 rounded", style:{ width: Math.round(value)+"%" } })
    )
  ]);
}

const endWrapper = isMobile ? "mx-auto w-full px-3 space-y-6" : (containerClass + " space-y-6");

return React.createElement("div", { className: endWrapper }, [
  React.createElement("div", { key:"brand", className:"flex items-center justify-between" }, [
    React.createElement(Brand, { size: isMobile?36:44, withText: true, text: "Welcome Fair — Trading Game" }),
    !isMobile && React.createElement("button", { onClick: () => setWide(w => !w), className:"px-3 py-2 rounded-xl border shadow-sm text-sm btn bg-white" }, wide ? "↔ Compact" : "⤢ Fit width")
  ]),
  React.createElement("h2", { key:"e0", className:"text-2xl font-bold" }, "Round complete"),
  React.createElement("div", { key:"e1", className:"grid md:grid-cols-3 gap-3 xl:gap-4" }, [
    React.createElement("div", { key:"e1a", className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white" }, [
      React.createElement("div", { className:"text-xs text-gray-500" }, "Trader"),
      React.createElement("div", { className:"text-2xl font-semibold" }, player)
    ]),
    React.createElement("div", { key:"e1b", className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white" }, [
      React.createElement("div", { className:"text-xs text-gray-500" }, "Mode"),
      React.createElement("div", { className:"text-2xl font-semibold" }, mode==="easy"?"Easy":"Normal")
    ]),
    React.createElement("div", { key:"e1c", className:"p-3 rounded-2xl border border-slate-200 shadow-sm bg-white" }, [
      React.createElement("div", { className:"text-xs text-gray-500" }, "Total Value"),
      React.createElement("div", { className:"text-2xl font-semibold" }, "$"+finalTotalText)
    ])
  ]),
  React.createElement("div", { key:"perf", className:"p-4 rounded-2xl border border-slate-200 shadow-sm bg-white space-y-3" }, [
    React.createElement("div", { className:"text-sm font-semibold" }, "Performance summary"),
    React.createElement("div", { className:"grid md:grid-cols-3 gap-3 xl:gap-4" }, [
      React.createElement(Bar, { key:"b1", label:"Reaction Speed", value: reactionScore, tooltip:"Score drops 20% per second after news." }),
      React.createElement(Bar, { key:"b2", label:"Directional Accuracy", value: accuracyScore, tooltip:"Traded with the news move." }),
      React.createElement(Bar, { key:"b3", label:"Risk / Confidence", value: riskScore, tooltip:"Time-weighted average position as % of max." })
    ]),
    React.createElement("div", { className:"text-sm text-gray-700" }, tips.length ? tips.join(" ") : "Solid round. Keep refining execution timing and sizing.")
  ]),

  React.createElement("div", { key:"e3", className:"mt-3 flex gap-2 flex-wrap" }, [
    React.createElement("button", { onClick: shareResultsImage, className:"px-3 py-2 rounded-xl border shadow-sm font-medium btn bg-green-50" }, "Share Image"),

    React.createElement("button", { onClick:()=>setScreen("welcome"), className:"px-3 py-2 rounded-xl border shadow-sm font-medium btn hover:bg-slate-50" }, "Back to Start"),
    React.createElement("button", { onClick:()=>{ 
      setScreen("play");
      const dur=(mode==="easy")?90:120; setDuration(dur); setTimeLeft(dur);
      setMid(100); setFair(100); setCash(100000); setReserve(0); setPos(0);
      setTick(0); tickRef.current = 0;
      setHist([{t:0, mid:100}]); setRegime("Calm"); setHeadline(null); setNotice("");
      setAvail(1000); setRevertTicks(0); setRevertStrength(0); pauseUntilRef.current = 0;
      newsEventsRef.current=[]; tradesRef.current=[]; avgPriceRef.current=null;
      const now = Date.now(); startTimeRef.current=now; endTimeRef.current=now+dur*1000;
      scheduleRef.current = (function(startMs, durSeconds){ const last=durSeconds-15; const arr=[]; for(let s=15;s<=last;s+=15) arr.push(startMs + s*1000); return arr; })(now, dur);
      nextNewsIdxRef.current=0;
    }, className:"px-3 py-2 rounded-xl border shadow-sm font-medium btn hover:bg-emerald-50" }, "Play Again")
  ])
]);

} // <-- closes function Game()

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(Game));
</script>
</body>
</html>






