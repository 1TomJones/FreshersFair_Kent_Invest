<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Freshers Fair — Liquidity Trading Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
      /* Mobile-first tweaks */
      @media (max-width: 480px) {
        .mobile-pad { padding: 10px !important; }
        .mobile-card { border-radius: 16px !important; }
        .btn-lg { padding: 14px !important; font-size: 16px !important; border-radius: 14px !important; }
        .btn-md { padding: 10px !important; font-size: 14px !important; border-radius: 12px !important; }
        .input-md { padding: 10px !important; font-size: 14px !important; border-radius: 12px !important; }
        .hide-on-mobile { display: none !important; }
      }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>
    <script>
      // === Supabase Leaderboard (your project) ===
      const SB_URL = "https://jlakntrrewqblgjsauq.supabase.co";
      const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsYWtudHJyZXdxYmxnbGpzYXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NDk3NDcsImV4cCI6MjA3NDMyNTc0N30.Is8AkR8rUsqczrZudanVa5N3jmYWFBl4cqY-OybBWsU";

      async function loadLBRemote() {
        try {
          const res = await fetch(
            `${SB_URL}/rest/v1/scores?select=name,pnl,total,ts&order=pnl.desc&limit=50`,
            { headers: { apikey: SB_KEY, Authorization: `Bearer ${SB_KEY}` } }
          );
          if (!res.ok) throw new Error("fetch failed");
          return await res.json();
        } catch (e) {
          console.warn("LB fetch error:", e);
          return [];
        }
      }
      async function saveLBRemote(entry) {
        try {
          await fetch(`${SB_URL}/rest/v1/scores`, {
            method: "POST",
            headers: {
              apikey: SB_KEY,
              Authorization: `Bearer ${SB_KEY}`,
              "Content-Type": "application/json",
              Prefer: "resolution=merge-duplicates"
            },
            body: JSON.stringify({ ...entry, mode: "normal" })
          });
        } catch (e) {
          console.warn("LB save error:", e);
        }
      }

      const { useState, useEffect, useRef } = React;

      const TICKER = "SPX";
      const fmt2 = n => Number(n).toFixed(2);
      const clamp = (x,a,b) => Math.max(a, Math.min(b, x));
      const MAX_POS = 1000;

      // ====== Audio (Web Audio API) ======
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      let audioCtx; try { audioCtx = new AudioCtx(); } catch(e) {}

      function _envGain(g, t0, dur, vol=0.03){ try{ g.gain.setValueAtTime(Math.max(0.0001, vol), t0); g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);}catch{} }
      function beep(freq=520, dur=0.15){ if(!audioCtx) return; const t=audioCtx.currentTime; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type="sine"; o.frequency.value=freq; _envGain(g,t,dur,0.03); o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+dur); }
      function chirp(a=420,b=880,d=0.18){ if(!audioCtx) return; const t=audioCtx.currentTime; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type="sine"; o.frequency.setValueAtTime(a,t); o.frequency.linearRampToValueAtTime(b,t+d); _envGain(g,t,d,0.03); o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+d); }
      function chord(freqs=[523,659,784], d=0.5){ if(!audioCtx) return; const t=audioCtx.currentTime; const bus=audioCtx.createGain(); bus.gain.setValueAtTime(0.02,t); bus.connect(audioCtx.destination); freqs.forEach(f=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type="sine"; o.frequency.value=f; _envGain(g,t,d,1); o.connect(g).connect(bus); o.start(t); o.stop(t+d); }); }

      // ---------- SVG line chart (mobile-friendly) ----------
      function PriceChart({ data, height=220, title=TICKER, fairLine=null }) {
        if (!data || data.length === 0) return React.createElement("div", { className: "h-[220px]"});
        const w = 860, h = height, padL = 40, padR = 12, padT = 18, padB = 22;
        const ys = data.map(d => d.mid);
        let minY = Math.min(...ys), maxY = Math.max(...ys);
        const padPct = 0.03;
        const midY = (minY + maxY) / 2;
        const halfRange = Math.max(0.0001, (maxY - minY) / 2);
        minY = midY - halfRange * (1 + padPct);
        maxY = midY + halfRange * (1 + padPct);
        const rangeY = Math.max(1e-6, maxY - minY);
        const n = data.length;

        const xOf = i => padL + (i / Math.max(1, n-1)) * (w - padL - padR);
        const yOf = v => h - padB - ((v - minY) / rangeY) * (h - padT - padB);

        const pts = data.map((d,i) => `${xOf(i)},${yOf(d.mid)}`).join(" ");

        const ticks = 4;
        const yTickElems = [];
        for (let k=0; k<ticks; k++) {
          const t = k/(ticks-1);
          const val = maxY - t*rangeY;
          const y = yOf(val);
          yTickElems.push(
            React.createElement("line", { key: "l"+k, x1: padL, y1: y, x2: w - padR, y2: y, stroke: "#f1f5f9", "stroke-width": 1 }),
            React.createElement("text", { key: "t"+k, x: padL - 6, y: y + 3, "text-anchor": "end", className: "fill-gray-500 text-[10px] font-medium" }, fmt2(val))
          );
        }

        const svgChildren = [
          React.createElement("line", { key:"ax1", x1: padL, y1: h - padB, x2: w - padR, y2: h - padB, stroke: "#e5e7eb", "stroke-width": 1 }),
          React.createElement("line", { key:"ax2", x1: padL, y1: padT, x2: padL, y2: h - padB, stroke: "#e5e7eb", "stroke-width": 1 }),
        ].concat(yTickElems);

        if (fairLine != null) {
          const yFV = yOf(fairLine);
          svgChildren.push(
            React.createElement("line", { key:"fv", x1: padL, y1: yFV, x2: w - padR, y2: yFV, stroke: "#94a3b8", "stroke-width": 1, "stroke-dasharray":"4 4", opacity:0.7 })
          );
        }

        svgChildren.push(React.createElement("polyline", { key:"ply", points: pts, fill: "none", stroke: "black", "stroke-width": 2 }));
        for (let i=0;i<data.length;i++){
          svgChildren.push(React.createElement("circle",{ key:"c"+i, cx: xOf(i), cy: yOf(data[i].mid), r: 1.8, fill:"black" }));
        }

        return React.createElement("div", { className: "p-2 rounded-2xl border shadow-sm bg-white mobile-card" },
          React.createElement("svg", { viewBox: `0 0 ${w} ${h}`, className: "w-full h-[220px]" }, svgChildren)
        );
      }

      // ---------- News (macro) ----------
      const NEWS = [
        { h:"BoE cuts rates 50bps",            why:"Cheaper borrowing supports equities",              pct:+0.10 },
        { h:"BoE hikes rates 50bps",           why:"Higher rates weigh on valuations",                 pct:-0.10 },
        { h:"Fed signals strong dovish turn",  why:"Lower expected path of rates",                     pct:+0.08 },
        { h:"Fed turns firmly hawkish",        why:"Higher-for-longer rates priced in",               pct:-0.08 },
        { h:"Inflation cools below forecast",  why:"Less pressure for hikes",                         pct:+0.05 },
        { h:"Inflation jumps above forecast",  why:"Hike risks rise",                                 pct:-0.05 },
        { h:"Geopolitical tensions escalate",  why:"Risk-off tone hits indices",                      pct:-0.06 },
        { h:"Geopolitical de-escalation",      why:"Risk-on tone improves",                           pct:+0.04 },
        { h:"Mixed data; outlook unchanged",   why:"Little impact on fair value",                     pct: 0.00 },
        { h:"Energy strength buoys index",     why:"Sector tailwind, modest index uplift",            pct:+0.02 },
        { h:"Consumer weakens broadly",        why:"Sector headwind, modest index drag",              pct:-0.02 },
      ];
      const pickNews = () => NEWS[Math.floor(Math.random()*NEWS.length)];

      // ---------- Fullscreen helpers (desktop) ----------
      async function enterFullscreen() {
        const el = document.documentElement;
        if (el.requestFullscreen) return el.requestFullscreen();
        if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
      }
      async function exitFullscreen() {
        if (document.exitFullscreen) return document.exitFullscreen();
        if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
      }

      function Game(){
        const [screen, setScreen] = useState("welcome");
        const [mode, setMode] = useState("normal"); // "normal" | "easy"
        const [player, setPlayer] = useState("");
        const [duration, setDuration] = useState(90);
        const [timeLeft, setTimeLeft] = useState(90);
        const [soundOn, setSoundOn] = useState(false);

        const [kiosk, setKiosk] = useState(false);
        async function toggleFS(){ try{ if(!document.fullscreenElement){ await enterFullscreen(); setKiosk(true);} else { await exitFullscreen(); setKiosk(false);} }catch{} }
        async function enableSound(){ try{ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); await audioCtx.resume(); setSoundOn(true);}catch{} }

        // market
        const [mid, _setMid] = useState(100);
        const [fair, _setFair] = useState(100);
        const spread = 0.10;
        const [hist, setHist] = useState([{t:0, mid:100}]);

        // liquidity/impact
        const BASE_DEPTH = 1000;
        const [availDepth, _setAvailDepth] = useState(BASE_DEPTH);
        const REPLENISH_PER_SEC = 0.10;
        const IMPACT_MIN = 0.005, IMPACT_MAX = 0.90, IMPACT_CURVE_POW = 2.2, LIQ_POWER = 0.5;

        // randomness
        const SIGMA_CALM_PCT = 0.0015, SIGMA_VOL_PCT = 0.0030;
        const JUMP_PROB_TICK = 0.001, JUMP_MIN_PCT = 0.003, JUMP_MAX_PCT = 0.010;

        // session
        const [cash, _setCash] = useState(100000);
        const [reserve, _setReserve] = useState(0);
        const [pos, _setPos] = useState(0);
        const [tick, setTick] = useState(0);
        const [size, setSize] = useState(100);

        const [regime, setRegime] = useState("Calm");
        const [headline, setHeadline] = useState(null);

        // Easy: pause on news
        const pauseUntilRef = useRef(0);

        // revert boost after big orders
        const [revertTicks, _setRevertTicks] = useState(0);
        const [revertStrength, _setRevertStrength] = useState(0);

        // refs
        const midRef=useRef(100), fairRef=useRef(100), cashRef=useRef(100000), posRef=useRef(0), availRef=useRef(BASE_DEPTH);
        const reserveRef=useRef(0);
        const loopRef=useRef(null), startTimeRef=useRef(null), endTimeRef=useRef(null);
        const scheduleRef=useRef([]), nextNewsIdxRef=useRef(0);
        const revertTicksRef=useRef(0), revertStrengthRef=useRef(0);

        const setMid   = v => { const x=typeof v==="function"?v(midRef.current):v;   midRef.current=x;   _setMid(x); };
        const setFair  = v => { const x=typeof v==="function"?v(fairRef.current):v;  fairRef.current=x;  _setFair(x); };
        const setCash  = v => { const x=typeof v==="function"?v(cashRef.current):v;  cashRef.current=x;  _setCash(x); };
        const setReserve = v => { const x=typeof v==="function"?v(reserveRef.current):v; reserveRef.current=x; _setReserve(x); };
        const setPos   = v => { const x=typeof v==="function"?v(posRef.current):v;   posRef.current=x;   _setPos(x); };
        const setAvail = v => { const x=typeof v==="function"?v(availRef.current):v; availRef.current=x; _setAvailDepth(x); };
        const setRevertTicks = v => { const x=typeof v==="function"?v(revertTicksRef.current):v; revertTicksRef.current=x; _setRevertTicks(x); };
        const setRevertStrength = v => { const x=typeof v==="function"?v(revertStrengthRef.current):v; revertStrengthRef.current=x; _setRevertStrength(x); };

        const total = cashRef.current + reserveRef.current + posRef.current*midRef.current;
        const pnl = total - 100000;

        // leaderboard state (remote)
        const [lb, setLb] = useState([]);
        useEffect(() => {
          let alive = true;
          async function go(){
            if (screen === "welcome" || screen === "end") {
              const rows = await loadLBRemote();
              if (alive) setLb(rows);
            }
          }
          go();
          return () => { alive=false; };
        }, [screen]);

        // drift toward FV (+ optional revert boost)
        function driftTowardFair(){
          const d = fairRef.current - midRef.current;
          const baseFactor = clamp(Math.abs(d)/10, 0, 1);
          const BETA_PER_SEC = 0.35;
          const betaTick = (mode==="easy" ? 0.35 : 0.35) / 10; // per 10Hz base
          let drift = betaTick * d * baseFactor;
          if (revertTicksRef.current > 0) {
            drift += revertStrengthRef.current * Math.sign(d) * Math.min(1, Math.abs(d)/0.5);
            setRevertTicks(t => t - 1);
            setRevertStrength(s => s * 0.6);
          }
          return clamp(drift, -0.12, +0.12);
        }
        function triggerRevertBoost(qty){
          if (qty >= 500) {
            const deviation = fairRef.current - midRef.current;
            const strength = 0.08 * (qty/1000) * (Math.abs(deviation)/1.0);
            setRevertStrength(strength);
            setRevertTicks(5);
          }
        }
        function resetRound(){
          setMid(100); setFair(100);
          setCash(100000); setReserve(0); setPos(0);
          setTick(0); setHist([{t:0, mid:100}]);
          setRegime("Calm"); setHeadline(null);
          setAvail(BASE_DEPTH);
          setRevertTicks(0); setRevertStrength(0);
          pauseUntilRef.current = 0;
        }
        function start(){
          if(!player.trim()) return alert("Enter a name to start!");
          resetRound();
          setScreen("play");
          const now = Date.now();
          startTimeRef.current = now;
          endTimeRef.current   = now + duration*1000;
          scheduleRef.current  = [15,30,45,60,75].map(s => now + s*1000);
          nextNewsIdxRef.current = 0;
        }
        function pauseFor(ms){
          const now = Date.now();
          pauseUntilRef.current = Math.max(pauseUntilRef.current, now + ms);
          endTimeRef.current += ms;
          for (let i = nextNewsIdxRef.current; i < scheduleRef.current.length; i++){
            scheduleRef.current[i] += ms;
          }
        }

        // main loop
        useEffect(() => {
          if (screen!=="play") return;
          if (loopRef.current) clearInterval(loopRef.current);

          const intervalMs = mode==="easy" ? 125 : 100; // ~8Hz vs 10Hz
          loopRef.current = setInterval(() => {
            const now = Date.now();

            if (now < pauseUntilRef.current) {
              setTimeLeft(Math.max(0, Math.ceil((endTimeRef.current - now)/1000)));
              return;
            }

            const left = Math.max(0, Math.ceil((endTimeRef.current - now)/1000));
            setTimeLeft(left);

            const sigmaPct = regime==="Calm" ? SIGMA_CALM_PCT : SIGMA_VOL_PCT;
            const sigmaAbs = fairRef.current * sigmaPct;
            let randomShock = (Math.random()*2 - 1) * sigmaAbs;

            if (Math.random() < JUMP_PROB_TICK) {
              const jMagPct = JUMP_MIN_PCT + Math.random()*(JUMP_MAX_PCT - JUMP_MIN_PCT);
              const sign = (Math.random()<0.5 ? -1 : +1);
              randomShock += sign * fairRef.current * jMagPct;
            }

            const biasShock = driftTowardFair();
            const step = randomShock + biasShock;

            setMid(m => {
              const nm = Math.max(1, m + step);
              setTick(t => { const t2=t+1; setHist(h=>[...h, {t:t2, mid:nm}].slice(-700)); return t2; });
              return nm;
            });

            const repl = BASE_DEPTH * (REPLENISH_PER_SEC * (intervalMs/1000));
            setAvail(a => clamp(a + repl, 50, BASE_DEPTH));

            if (Math.random() < 0.03) setRegime(r => r==="Calm"?"Volatile":"Calm");

            const idx = nextNewsIdxRef.current;
            if (idx < scheduleRef.current.length && now >= scheduleRef.current[idx]) {
              const n = pickNews(); setHeadline(n);
              if (soundOn) { if (n.pct>0) beep(740,0.18); else if (n.pct<0) beep(330,0.18); else beep(520,0.12); }
              if (n.pct !== 0) setFair(f => Math.max(1, f * (1 + n.pct)));
              nextNewsIdxRef.current = idx + 1;
              if (mode === "easy") pauseFor(5000);
            }

            if (left <= 0) {
              clearInterval(loopRef.current); loopRef.current = null;
              const finalTotal = cashRef.current + reserveRef.current + posRef.current * midRef.current;
              const finalPnl = finalTotal - 100000;
              if (soundOn) { if (finalPnl>0) chord([523,659,784],0.6); else chord([196,233,262],0.6); }
              if (mode === "normal") {
                const entry = {
                  name: (player||"").trim().replace(/\s+/g," ").slice(0,32) || "Guest",
                  pnl: Number(finalPnl.toFixed(2)),
                  total: Number(finalTotal.toFixed(2))
                };
                saveLBRemote(entry);
              }
              setScreen("end");
            }
          }, intervalMs);

          return () => { if (loopRef.current) { clearInterval(loopRef.current); loopRef.current=null; } };
        }, [screen, duration, regime, soundOn, mode]);

        function trade(side){
          const reqQty = Math.max(1, Math.round(size));
          const sgn = side==="BUY" ? +1 : -1;

          const maxAdd = (sgn>0) ? MAX_POS - posRef.current : MAX_POS + posRef.current;
          const qty = clamp(reqQty, 0, Math.max(0, maxAdd));
          if (qty === 0) { if (navigator.vibrate) navigator.vibrate(20); return; }

          const startMid = midRef.current;
          const aD = Math.max(50, availRef.current);
          const after100 = Math.max(0, qty - 100);
          const x = after100 / 900;
          const curve = Math.pow(x, IMPACT_CURVE_POW);
          const liquidityFactor = Math.pow(BASE_DEPTH / aD, LIQ_POWER);
          const impactMag = (IMPACT_MIN + (IMPACT_MAX - IMPACT_MIN) * curve) * liquidityFactor;
          const impact = sgn * impactMag;
          const endMid = Math.max(1, startMid + impact);

          const vwap =
            side==="BUY"
              ? (startMid + spread/2) + 0.5 * (endMid - startMid)
              : (startMid - spread/2) + 0.5 * (endMid - startMid);

          const notional = qty * vwap;
          const fee = notional * 0.0001;

          if (side==="BUY") {
            setCash(c=>c - fee);
            if (posRef.current < 0) {
              setReserve(r => { const r2 = r - notional; if (r2 >= 0) return r2; setCash(c => c + r2); return 0; });
            } else {
              setCash(c=>c - notional);
            }
            setPos(p=>p + qty);
          } else {
            setCash(c=>c - fee);
            if (posRef.current > 0) { setCash(c=>c + notional); }
            else { setReserve(r=>r + notional); }
            setPos(p=>p - qty);
          }

          setTimeout(() => {
            if (posRef.current >= 0 && reserveRef.current > 0) { setCash(c => c + reserveRef.current); setReserve(0); }
          }, 0);

          if (soundOn) { if (side==="BUY") chirp(420,880); else chirp(880,420); }
          if (navigator.vibrate) navigator.vibrate(15);

          setMid(endMid);
          setTick(t => { const t2=t+1; setHist(h=>[...h, {t:t2, mid:endMid}].slice(-700)); return t2; });
          setAvail(a => clamp(a - qty, 50, BASE_DEPTH));
          triggerRevertBoost(qty);
        }

        // ---------- UI helpers ----------
        const isMobile = typeof window !== "undefined" ? window.innerWidth <= 480 : false;
        const pnlColor = pnl>0?"text-green-600":(pnl<0?"text-rose-600":"text-gray-900");

        // News banner (colored in Easy; neutral in Normal)
        function NewsBanner() {
          if (!headline) return null;
          const colored = (mode === "easy");
          const klass = colored
            ? (headline.pct>0?"bg-emerald-50 border-emerald-300":(headline.pct<0?"bg-rose-50 border-rose-300":"bg-slate-50 border-slate-300"))
            : "bg-white border-slate-200";
          return React.createElement("div", { className:`p-2 rounded-xl border shadow-sm ${klass} mobile-card` }, [
            React.createElement("div", { key:"a", className:"text-xs font-semibold" }, colored ? (headline.pct>0?"▲ Positive macro":headline.pct<0?"▼ Negative macro":"→ Neutral macro") : "News"),
            React.createElement("div", { key:"b", className:"text-sm" }, headline.h),
            React.createElement("div", { key:"c", className:"text-[11px] text-gray-700 mt-0.5" }, `${headline.why}${headline.pct===0 ? "" : ` — fair value ${(headline.pct*100).toFixed(0)}%.`}`)
          ]);
        }

        // ---- Screens ----
        if (screen==="welcome"){
          const leader = (lb.length===0
            ? React.createElement("div", { className:"text-sm text-gray-500" }, "No scores yet — be the first!")
            : React.createElement("ol", { className:"text-sm space-y-1" },
                lb.slice(0,10).map((r,i)=>
                  React.createElement("li", { key:i, className:"flex justify-between" },
                    React.createElement("span", null, `${i+1}. ${r.name}`),
                    React.createElement("span", { className:r.pnl>0?"text-green-600":(r.pnl<0?"text-rose-600":"") }, `$${fmt2(r.pnl)}`)
                  )
                )
              )
          );

          const modeExplainer = React.createElement("div", { className:"text-sm text-gray-700 p-3 rounded-2xl border bg-white shadow-sm mobile-card" },
            ["Pick a mode: ",
             React.createElement("b",{key:"b1"},"Easy"),
             " gives colored news cues and pauses 5s on headlines (slower ticks). ",
             React.createElement("b",{key:"b2"},"Normal"),
             " has no assists, full speed, and writes to the leaderboard."]);

          const modeChoices = React.createElement("div", { className:"grid md:grid-cols-2 gap-3" }, [
            React.createElement("label", { key:"m1", className:"p-3 rounded-2xl border shadow-sm bg-white flex gap-3 cursor-pointer mobile-card" },
              React.createElement("input", { type:"radio", name:"mode", className:"mt-1", checked: mode==="easy", onChange:()=>setMode("easy") }),
              React.createElement("div", null,
                React.createElement("div", { className:"font-semibold" }, "Easy"),
                React.createElement("div", { className:"text-sm text-gray-600" }, "Colored news, 5s pause on headlines, ~8Hz.")
              )
            ),
            React.createElement("label", { key:"m2", className:"p-3 rounded-2xl border shadow-sm bg-white flex gap-3 cursor-pointer mobile-card" },
              React.createElement("input", { type:"radio", name:"mode", className:"mt-1", checked: mode==="normal", onChange:()=>setMode("normal") }),
              React.createElement("div", null,
                React.createElement("div", { className:"font-semibold" }, "Normal"),
                React.createElement("div", { className:"text-sm text-gray-600" }, "No assists, full speed (~10Hz). Leaderboard.")
              )
            )
          ]);

          return React.createElement("div", { className:"max-w-5xl mx-auto p-4 space-y-5 mobile-pad" }, [
            React.createElement("h1", { key:"h", className:"text-2xl md:text-3xl font-bold" }, "Freshers Fair — Liquidity Trading Game"),
            modeExplainer,
            modeChoices,
            React.createElement("div", { key:"form", className:"p-4 rounded-2xl border shadow-sm bg-white grid md:grid-cols-3 gap-3 items-end mobile-card" }, [
              React.createElement("div", { key:"n" },
                React.createElement("label", { className:"text-xs text-gray-500" }, "Your name"),
                React.createElement("input", { value:player, onChange:e=>setPlayer(e.target.value),
                  className:"w-full border rounded-xl px-3 py-2 mt-1 input-md", placeholder:"e.g., Alex" })
              ),
              React.createElement("div", { key:"d" },
                React.createElement("label", { className:"text-xs text-gray-500" }, "Round duration (seconds — news every 15s)"),
                React.createElement("input", { type:"number", min:60, step:15, value:duration,
                  onChange:e=>setDuration(clamp(Number(e.target.value)||90, 60, 600)),
                  className:"w-full border rounded-xl px-3 py-2 mt-1 input-md" })
              ),
              React.createElement("div", { key:"btns", className:"flex gap-2" }, [
                React.createElement("button", { key:"start", onClick:start,
                  className:"px-4 py-3 rounded-xl border shadow-sm font-semibold transition hover:bg-emerald-50 active:scale-[0.98] btn-lg" }, "Start Round"),
                React.createElement("button", { key:"snd", onClick: enableSound,
                  className:"px-4 py-3 rounded-xl border shadow-sm text-sm transition hover:bg-slate-50 active:scale-[0.98] btn-md" },
                  soundOn ? "🔊" : "🔇")
              ])
            ]),
            React.createElement("div", { key:"lb", className:"p-4 rounded-2xl border shadow-sm bg-white mobile-card" }, [
              React.createElement("div", { className:"text-sm font-semibold mb-2" }, "Leaderboard (Normal) — Top 10"),
              leader
            ])
          ]);
        }

        if (screen==="play"){
          // MOBILE-FIRST LAYOUT
          const mobileUI = React.createElement("div", { className:"max-w-md mx-auto p-3 space-y-3 mobile-pad" }, [
            React.createElement(NewsBanner, { key:"nb" }),
            React.createElement(PriceChart, { key:"ch", data: hist, title: TICKER, fairLine: fairRef.current }),
            React.createElement("div", { key:"stats", className:"grid grid-cols-2 gap-2" }, [
              React.createElement("div", { className:"p-2 rounded-xl border bg-white text-center mobile-card" },
                React.createElement("div", { className:"text-[11px] text-gray-500" }, "PnL"),
                React.createElement("div", { className:"text-xl font-semibold "+(pnl>0?"text-green-600":(pnl<0?"text-rose-600":"text-gray-900")) }, "$"+fmt2(pnl))
              ),
              React.createElement("div", { className:"p-2 rounded-xl border bg-white text-center mobile-card" },
                React.createElement("div", { className:"text-[11px] text-gray-500" }, "Position"),
                React.createElement("div", { className:"text-xl font-semibold" }, `${posRef.current} sh`)
              )
            ]),
            React.createElement("div", { key:"trade", className:"p-2 rounded-xl border bg-white space-y-2 mobile-card" }, [
              React.createElement("div", { className:"flex gap-2" }, [
                React.createElement("input", { key:"sz", type:"number", min:1, step:1, value:size,
                  onChange:e=>setSize(clamp(Number(e.target.value)||0, 1, 1000000)),
                  className:"w-full border rounded-xl px-3 py-2 input-md", placeholder:"Order size" }),
                React.createElement("button", { key:"snd", onClick: enableSound, className:"px-3 py-2 rounded-xl border btn-md" }, soundOn?"🔊":"🔇")
              ]),
              React.createElement("div", { className:"grid grid-cols-2 gap-2" }, [
                React.createElement("button", { key:"sell", onClick:()=>trade("SELL"),
                  className:"w-full btn-lg border shadow-sm font-semibold transition hover:bg-rose-50 active:scale-[0.98]" }, "SELL"),
                React.createElement("button", { key:"buy", onClick:()=>trade("BUY"),
                  className:"w-full btn-lg border shadow-sm font-semibold transition hover:bg-emerald-50 active:scale-[0.98]" }, "BUY")
              ]),
              React.createElement("div", { className:"text-[11px] text-gray-500 text-center" }, "Cap ±"+MAX_POS+" sh · Fee 0.01%")
            ]),
            React.createElement("div", { key:"footer", className:"flex items-center justify-between text-xs text-gray-600" }, [
              React.createElement("span", null, (mode==="easy"?"Easy":"Normal")+" · "+TICKER),
              React.createElement("span", null, "⏱ "+timeLeft+"s")
            ])
          ]);

          // DESKTOP layout (unchanged essentials + fullscreen)
          const desktopUI = React.createElement("div", { className:"max-w-5xl mx-auto p-4 space-y-4" }, [
            React.createElement("header", { key:"hdr", className:"flex items-center justify-between hide-on-mobile" }, [
              React.createElement("div", { key:"tr", className:"text-xl font-semibold" }, `Trader: ${player}`),
              React.createElement("div", { key:"rt", className:"flex items-center gap-2" }, [
                React.createElement("span", { className:"px-2 py-1 rounded-full text-xs border bg-white" }, "⏱ "+timeLeft+"s"),
                React.createElement("span", { className:"px-2 py-1 rounded-full text-xs border bg-white" }, (mode==="easy"?"Easy":"Normal")+" · "+TICKER),
                React.createElement("button", { onClick: enableSound, className:"px-2 py-1 rounded-full text-xs border bg-white" }, soundOn?"🔊":"🔇"),
                React.createElement("button", { onClick: toggleFS, className:"px-2 py-1 rounded-full text-xs border bg-white" }, document.fullscreenElement ? "⤢" : "⤢")
              ])
            ]),
            React.createElement(NewsBanner, { key:"nb" }),
            React.createElement(PriceChart, { key:"ch", data: hist, title: TICKER, fairLine: fairRef.current }),
            React.createElement("div", { key:"row", className:"grid md:grid-cols-3 gap-3 items-end" }, [
              React.createElement("div", { className:"p-4 rounded-2xl border shadow-sm bg-white space-y-3" }, [
                React.createElement("div", { className:"text-sm font-semibold" }, "Trade"),
                React.createElement("label", { className:"text-xs text-gray-500" }, "Order size (shares)"),
                React.createElement("input", { type:"number", min:1, step:1, value:size,
                  onChange:e=>setSize(clamp(Number(e.target.value)||0, 1, 1000000)),
                  className:"w-full border rounded-xl px-3 py-2" }),
                React.createElement("div", { className:"grid grid-cols-2 gap-2" }, [
                  React.createElement("button", { onClick:()=>trade("SELL"),
                    className:"px-3 py-2 rounded-xl border shadow-sm font-medium transition hover:bg-rose-50 active:scale-[0.98]" }, "SELL"),
                  React.createElement("button", { onClick:()=>trade("BUY"),
                    className:"px-3 py-2 rounded-xl border shadow-sm font-medium transition hover:bg-emerald-50 active:scale-[0.98]" }, "BUY")
                ]),
                React.createElement("div", { className:"flex justify-between text-xs text-gray-500" },
                  React.createElement("div", null, "Fee: 0.01% notional"),
                  React.createElement("div", null, `Pos cap: ±${MAX_POS} sh · Liquidity refills`)
                )
              ]),
              React.createElement("div", { className:"p-4 rounded-2xl border shadow-sm bg-white space-y-3" }, [
                React.createElement("div", { className:"text-sm font-semibold" }, "PnL / Position"),
                React.createElement("div", { className:"text-2xl font-semibold "+pnlColor }, "$"+fmt2(pnl)),
                React.createElement("div", { className:"text-sm text-gray-700" }, `Position: ${posRef.current} sh`)
              ]),
              React.createElement("div", { className:"p-4 rounded-2xl border shadow-sm bg-white space-y-2" }, [
                React.createElement("div", { className:"text-sm font-semibold" }, "Round"),
                React.createElement("button", {
                  onClick:()=>{ if(confirm("End round now?")){ endTimeRef.current = Date.now(); } },
                  className:"px-3 py-2 rounded-xl border shadow-sm font-medium transition hover:bg-slate-50 active:scale-[0.98]"
                }, "End Round"),
                React.createElement("div", { className:"text-xs text-gray-500" }, mode==="easy"
                  ? "Easy: colored news, 5s pause, slower ticks."
                  : "Normal: no assists, leaderboard.")
              ])
            ])
          ]);

          return isMobile ? mobileUI : desktopUI;
        }

        // End screen
        if (screen==="end"){
          const finalTotalText = (cashRef.current + reserveRef.current + posRef.current*midRef.current).toLocaleString();
          const leaderBox = React.createElement("div", { className:"p-4 rounded-2xl border shadow-sm bg-white mobile-card" }, [
            React.createElement("div", { className:"text-sm font-semibold mb-2" }, "Leaderboard (Normal) — Top 10"),
            (lb.length===0
              ? React.createElement("div", { className:"text-sm text-gray-500" }, "No scores yet — be the first!")
              : React.createElement("ol", { className:"text-sm space-y-1" },
                  lb.slice(0,10).map((r,i)=>
                    React.createElement("li", { key:i, className:"flex justify-between" },
                      React.createElement("span", null, `${i+1}. ${r.name}`),
                      React.createElement("span", { className:r.pnl>0?"text-green-600":(r.pnl<0?"text-rose-600":"") }, `$${fmt2(r.pnl)}`)
                    )
                  )
                )
            )
          ]);

          return React.createElement("div", { className:"max-w-5xl mx-auto p-4 space-y-5 mobile-pad" }, [
            React.createElement("h2", { className:"text-2xl font-bold" }, "Round complete"),
            React.createElement("div", { className:"grid md:grid-cols-3 gap-3" }, [
              React.createElement("div", { className:"p-3 rounded-2xl border shadow-sm bg-white mobile-card" },
                React.createElement("div", { className:"text-xs text-gray-500" }, "Trader"),
                React.createElement("div", { className:"text-2xl font-semibold" }, player)
              ),
              React.createElement("div", { className:"p-3 rounded-2xl border shadow-sm bg-white mobile-card" },
                React.createElement("div", { className:"text-xs text-gray-500" }, "Mode"),
                React.createElement("div", { className:"text-2xl font-semibold" }, mode==="easy"?"Easy":"Normal")
              ),
              React.createElement("div", { className:"p-3 rounded-2xl border shadow-sm bg-white mobile-card" },
                React.createElement("div", { className:"text-xs text-gray-500" }, "Total Value"),
                React.createElement("div", { className:"text-2xl font-semibold" }, "$"+finalTotalText)
              )
            ]),
            (mode==="normal" ? leaderBox
              : React.createElement("div", { className:"p-4 rounded-2xl border shadow-sm bg-white text-sm text-gray-600 mobile-card" },
                  "Easy mode results are not recorded in the leaderboard. Try Normal mode to compete!")),
            React.createElement("div", { className:"mt-3 flex gap-2" }, [
              React.createElement("button", {
                onClick:()=>setScreen("welcome"),
                className:"px-3 py-2 rounded-xl border shadow-sm font-medium transition hover:bg-slate-50 active:scale-[0.98]"
              }, "Back to Start"),
              React.createElement("button", {
                onClick:()=>{ setScreen("play"); // quick restart
                  setMid(100); setFair(100); setCash(100000); setReserve(0); setPos(0);
                  setTick(0); setHist([{t:0, mid:100}]); setRegime("Calm"); setHeadline(null);
                  setAvail(1000); setRevertTicks(0); setRevertStrength(0); pauseUntilRef.current = 0;
                  const now = Date.now(); startTimeRef.current=now; endTimeRef.current=now+duration*1000;
                  scheduleRef.current=[15,30,45,60,75].map(s=>now+s*1000); nextNewsIdxRef.current=0;
                },
                className:"px-3 py-2 rounded-xl border shadow-sm font-medium transition hover:bg-emerald-50 active:scale-[0.98]"
              }, "Play Again")
            ])
          ]);
        }

        return null;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(Game));
    </script>
  </body>
</html>
